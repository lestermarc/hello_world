--------------------------------------------------------
--  DDL for Package Body ACR_RPT
--------------------------------------------------------

  CREATE OR REPLACE PACKAGE BODY "ACR_RPT" 
is


   PROCEDURE ACR_ACC_IMPUTATION_DET_RPT_PK (
      aRefCursor     in out CRYSTAL_CURSOR_TYPES.DualCursorTyp,
      PROCPARAM_0    in     varchar2,
      PROCPARAM_1    in     varchar2,
      PROCPARAM_2    in     varchar2,
      PROCPARAM_3    in     varchar2,
      PARAMETER_5    in     varchar2,
      PARAMETER_6    in     varchar2,
      PARAMETER_7    in     varchar2,
      PARAMETER_8    in     varchar2,
      PARAMETER_12   in     varchar2,
      PROCUSER_LANID in  pcs.pc_lang.lanid%type
)
is
/**
  Procédure stockée utilisée pour les rapports ACR_ACC_IMPUTATION_DET
  (Grand livre standard et grand livre pour les communes bernoises)
*/

TMP NUMBER;
VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;

BEGIN

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);
VPC_LANG_ID:= pcs.PC_I_LIB_SESSION.GetUserLangId;

SELECT decode(min(ACS_SUB_SET_ID), null,0,1) INTO TMP
  FROM ACS_SUB_SET
  WHERE C_TYPE_SUB_SET = 'DIVI';

ACR_FUNCTIONS.EXIST_DIVISION := TMP;

open aRefCursor for
SELECT
IMP_TOT.INFO,
IMP_TOT.ACT_FINANCIAL_IMPUTATION_ID,
IMP_TOT.ACS_FINANCIAL_ACCOUNT_ID,
IMP_TOT.FIN_NUMBER,
IMP_TOT.FIN_DESCR,
IMP_TOT.FIN_LARGE_DESCR,
IMP_TOT.ACC_NUMBER_CE,
IMP_TOT.IMF_TRANSACTION_DATE,
IMP_TOT.IMF_VALUE_DATE,
IMP_TOT.IMF_DESCRIPTION,
IMP_TOT.ACS_DIVISION_ACCOUNT_ID,
IMP_TOT.DIV_NUMBER,
IMP_TOT.DIV_DESCR,
IMP_TOT.ACS_TAX_CODE_ID,
IMP_TOT.TAX_NUMBER,
IMP_TOT.ACS_ACS_FINANCIAL_CURRENCY_ID,
IMP_TOT.CURRENCY_MB,
IMP_TOT.ACS_FINANCIAL_CURRENCY_ID,
IMP_TOT.CURRENCY_ME,
IMP_TOT.IMF_EXCHANGE_RATE,
IMP_TOT.IMF_AMOUNT_LC_D,
IMP_TOT.IMF_AMOUNT_LC_C,
IMP_TOT.IMF_AMOUNT_FC_D,
IMP_TOT.IMF_AMOUNT_FC_C,
IMP_TOT.ACS_PERIOD_ID,
IMP_TOT.IMF_TYPE,
IMP_TOT.ACS_AUXILIARY_ACCOUNT_ID,
IMP_TOT.AUX_NUMBER,
IMP_TOT.AUX_SHORT_DESCR,
IMP_TOT.DIC_IMP_FREE1_ID,
IMP_TOT.DIC_IMP_FREE2_ID,
IMP_TOT.DIC_IMP_FREE3_ID,
IMP_TOT.DIC_IMP_FREE4_ID,
IMP_TOT.DIC_IMP_FREE5_ID,
IMP_TOT.DOC_RECORD_ID,
IMP_TOT.FAM_FIXED_ASSETS_ID,
IMP_TOT.GCO_GOOD_ID,
IMP_TOT.PAC_PERSON_ID,
IMP_TOT.HRM_PERSON_ID,
IMP_TOT.IMF_NUMBER,
IMP_TOT.IMF_NUMBER2,
IMP_TOT.IMF_NUMBER3,
IMP_TOT.IMF_NUMBER4,
IMP_TOT.IMF_NUMBER5,
IMP_TOT.IMF_TEXT1,
IMP_TOT.IMF_TEXT2,
IMP_TOT.IMF_TEXT3,
IMP_TOT.IMF_TEXT4,
IMP_TOT.IMF_TEXT5,
IMP_TOT.ACS_FINANCIAL_YEAR_ID,
IMP_TOT.FYE_START_DATE,
IMP_TOT.FYE_END_DATE,
IMP_TOT.PER_START_DATE,
IMP_TOT.PER_END_DATE,
IMP_TOT.C_TYPE_PERIOD,
IMP_TOT.ACT_DOCUMENT_ID,
IMP_TOT.DOC_NUMBER,
IMP_TOT.DOC_DATE_DELIVERY,
IMP_TOT.ACT_ACT_JOURNAL_ID,
IMP_TOT.ACT_JOURNAL_ID,
IMP_TOT.JOU_NUMBER,
IMP_TOT.JOU_DESCRIPTION,
IMP_TOT.C_ETAT_JOURNAL,
IMP_TOT.C_TYPE_CUMUL,
IMP_TOT.ACC_DETAIL_PRINTING,
IMP_TOT.C_TYPE_JOURNAL,
IMP_TOT.PER_AMOUNT_D,
IMP_TOT.PER_AMOUNT_C,
IMP_TOT.ACB_BUDGET_ID,
IMP_TOT.ACB_BUDGET_VERSION_ID,
IMP_TOT.ACB_GLOBAL_BUDGET_ID,
CYN.CURRENCY_NO
FROM
(
SELECT
    'REEL' INFO,
    IMP.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    (SELECT ACC.ACC_NUMBER
      FROM ACS_ACCOUNT               ACC,
           ACT_FINANCIAL_IMPUTATION  IMC
      WHERE IMC.ACT_FINANCIAL_IMPUTATION_ID = ACR_FUNCTIONS.GetFinancialImputationId(IMP.ACT_FINANCIAL_IMPUTATION_ID) AND
            IMC.ACS_FINANCIAL_ACCOUNT_ID    = ACC.ACS_ACCOUNT_ID) ACC_NUMBER_CE,
    IMP.IMF_TRANSACTION_DATE IMF_TRANSACTION_DATE,
    IMP.IMF_VALUE_DATE IMF_VALUE_DATE,
    IMP.IMF_DESCRIPTION IMF_DESCRIPTION,
    IMP.IMF_ACS_DIVISION_ACCOUNT_ID ACS_DIVISION_ACCOUNT_ID,
    (SELECT ACD.ACC_NUMBER
      FROM ACS_ACCOUNT ACD
      WHERE ACD.ACS_ACCOUNT_ID = IMP.IMF_ACS_DIVISION_ACCOUNT_ID) DIV_NUMBER,
    (SELECT DED.DES_DESCRIPTION_SUMMARY
      FROM ACS_DESCRIPTION DED
      WHERE DED.ACS_ACCOUNT_ID   = IMP.IMF_ACS_DIVISION_ACCOUNT_ID AND
            DED.PC_LANG_ID       = VPC_LANG_ID) DIV_DESCR,
    IMP.ACS_TAX_CODE_ID ACS_TAX_CODE_ID,
    (SELECT ACV.ACC_NUMBER
      FROM ACS_ACCOUNT ACV
      WHERE ACV.ACS_ACCOUNT_ID = IMP.ACS_TAX_CODE_ID) TAX_NUMBER,
    IMP.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = IMP.ACS_ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    IMP.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = IMP.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_ME,
    IMP.IMF_EXCHANGE_RATE IMF_EXCHANGE_RATE,
    IMP.IMF_AMOUNT_LC_D IMF_AMOUNT_LC_D,
    IMP.IMF_AMOUNT_LC_C IMF_AMOUNT_LC_C,
    IMP.IMF_AMOUNT_FC_D IMF_AMOUNT_FC_D,
    IMP.IMF_AMOUNT_FC_C IMF_AMOUNT_FC_C,
    IMP.ACS_PERIOD_ID ACS_PERIOD_ID,
    IMP.IMF_TYPE IMF_TYPE,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_SHORT_DESCR,
    IMP.DIC_IMP_FREE1_ID DIC_IMP_FREE1_ID,
    IMP.DIC_IMP_FREE2_ID DIC_IMP_FREE2_ID,
    IMP.DIC_IMP_FREE3_ID DIC_IMP_FREE3_ID,
    IMP.DIC_IMP_FREE4_ID DIC_IMP_FREE4_ID,
    IMP.DIC_IMP_FREE5_ID DIC_IMP_FREE5_ID,
    IMP.DOC_RECORD_ID DOC_RECORD_ID,
    IMP.FAM_FIXED_ASSETS_ID FAM_FIXED_ASSETS_ID,
    IMP.GCO_GOOD_ID GCO_GOOD_ID,
    IMP.PAC_PERSON_ID PAC_PERSON_ID,
    IMP.HRM_PERSON_ID HRM_PERSON_ID,
    IMP.IMF_NUMBER IMF_NUMBER,
    IMP.IMF_NUMBER2 IMF_NUMBER2,
    IMP.IMF_NUMBER3 IMF_NUMBER3,
    IMP.IMF_NUMBER4 IMF_NUMBER4,
    IMP.IMF_NUMBER5 IMF_NUMBER5,
    IMP.IMF_TEXT1 IMF_TEXT1,
    IMP.IMF_TEXT2 IMF_TEXT2,
    IMP.IMF_TEXT3 IMF_TEXT3,
    IMP.IMF_TEXT4 IMF_TEXT4,
    IMP.IMF_TEXT5 IMF_TEXT5,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    FYE.FYE_START_DATE  FYE_START_DATE,
    FYE.FYE_END_DATE FYE_END_DATE,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    (SELECT PAR.DOC_DATE_DELIVERY
      FROM ACT_PART_IMPUTATION PAR
      WHERE PAR.ACT_PART_IMPUTATION_ID = IMP.ACT_PART_IMPUTATION_ID) DOC_DATE_DELIVERY,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
      FROM ACT_ETAT_JOURNAL ETA
      WHERE ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
            ETA.C_SUB_SET      = 'ACC') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
      FROM ACJ_SUB_SET_CAT SCA
      WHERE SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
            SCA.C_SUB_SET                 = 'ACC') C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION           DES,
    ACT_JOURNAL               JOU,
    ACT_DOCUMENT              DOC,
    ACS_PERIOD                PER,
    ACS_FINANCIAL_YEAR        FYE,
    ACT_FINANCIAL_IMPUTATION  IMP,
    ACS_ACCOUNT               ACC,
    ACS_FINANCIAL_ACCOUNT     FIN
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = ACC.ACS_ACCOUNT_ID AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = IMP.ACS_FINANCIAL_ACCOUNT_ID AND
    FYE.FYE_NO_EXERCICE                 = TO_NUMBER(PROCPARAM_0) AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    IMP.ACS_PERIOD_ID                   = PER.ACS_PERIOD_ID AND
    IMP.ACT_DOCUMENT_ID                 = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_JOURNAL_ID                  = JOU.ACT_JOURNAL_ID AND
   (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||IMP.IMF_ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null) AND
    ACC.ACS_ACCOUNT_ID                  = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID                                   = VPC_LANG_ID
UNION ALL
SELECT
    'REPORT' INFO,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    NULL ACC_NUMBER_CE,
    FYE.FYE_START_DATE IMF_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMF_VALUE_DATE,
    'Report' IMF_DESCRIPTION,
    TOT.ACS_DIVISION_ACCOUNT_ID,
    (SELECT ACD.ACC_NUMBER
      FROM ACS_ACCOUNT ACD
      WHERE ACD.ACS_ACCOUNT_ID = TOT.ACS_DIVISION_ACCOUNT_ID) DIV_NUMBER,
    (SELECT DED.DES_DESCRIPTION_SUMMARY
      FROM ACS_DESCRIPTION DED
      WHERE DED.ACS_ACCOUNT_ID   = TOT.ACS_DIVISION_ACCOUNT_ID AND
            DED.PC_LANG_ID       = VPC_LANG_ID) DIV_DESCR,
    0 ACS_TAX_CODE_ID,
    NULL TAX_NUMBER,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = TOT.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = TOT.ACS_ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_ME,
    0 IMF_EXCHANGE_RATE,
    TOT.TOT_DEBIT_LC IMF_AMOUNT_LC_D,
    TOT.TOT_CREDIT_LC IMF_AMOUNT_LC_C,
    TOT.TOT_DEBIT_FC IMF_AMOUNT_FC_D,
    TOT.TOT_CREDIT_FC IMF_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    'MAN' IMF_TYPE,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    NULL DOC_RECORD_ID,
    NULL FAM_FIXED_ASSETS_ID,
    NULL GCO_GOOD_ID,
    NULL PAC_PERSON_ID,
    NULL HRM_PERSON_ID,
    NULL IMF_NUMBER,
    NULL IMF_NUMBER2,
    NULL IMF_NUMBER3,
    NULL IMF_NUMBER4,
    NULL IMF_NUMBER5,
    NULL IMF_TEXT1,
    NULL IMF_TEXT2,
    NULL IMF_TEXT3,
    NULL IMF_TEXT4,
    NULL IMF_TEXT5,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    FYE.FYE_START_DATE  FYE_START_DATE,
    FYE.FYE_END_DATE FYE_END_DATE,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    NULL DOC_DATE_DELIVERY,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    NULL JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    'OPB' C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION       DES,
    ACS_FINANCIAL_YEAR    FYE,
    ACS_PERIOD            PER,
    ACS_FINANCIAL_ACCOUNT FIN,
    ACS_ACCOUNT           ACC,
    ACT_TOTAL_BY_PERIOD   TOT
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = ACC.ACS_ACCOUNT_ID AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = TOT.ACS_FINANCIAL_ACCOUNT_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    TOT.ACS_AUXILIARY_ACCOUNT_ID is null AND
    FYE.FYE_NO_EXERCICE                 = TO_NUMBER(PROCPARAM_0) AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID                   = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD                   = '1' AND
    ((TOT.ACS_DIVISION_ACCOUNT_ID is not null) or (TOT.ACS_DIVISION_ACCOUNT_ID is null and ACR_FUNCTIONS.ExistDivision = 0)) AND
    (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||TOT.ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null) AND
       ACC.ACS_ACCOUNT_ID                  = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID                      = VPC_LANG_ID
UNION ALL
SELECT
    'BUDGET' INFO,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    NULL ACC_NUMBER_CE,
    NULL IMF_TRANSACTION_DATE,
    NULL IMF_VALUE_DATE,
    NULL IMF_DESCRIPTION,
    GLO.ACS_DIVISION_ACCOUNT_ID ACS_DIVISION_ACCOUNT_ID,
    (SELECT ACD.ACC_NUMBER
      FROM ACS_ACCOUNT ACD
      WHERE ACD.ACS_ACCOUNT_ID = GLO.ACS_DIVISION_ACCOUNT_ID) DIV_NUMBER,
    (SELECT DED.DES_DESCRIPTION_SUMMARY
      FROM ACS_DESCRIPTION DED
      WHERE DED.ACS_ACCOUNT_ID    = GLO.ACS_DIVISION_ACCOUNT_ID AND
            DED.PC_LANG_ID        = VPC_LANG_ID) DIV_DESCR,
    0 ACS_TAX_CODE_ID,
    NULL TAX_NUMBER,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = GLO.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMF_EXCHANGE_RATE,
    0 IMF_AMOUNT_LC_D,
    0 IMF_AMOUNT_LC_C,
    0 IMF_AMOUNT_FC_D,
    0 IMF_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    'MAN' IMF_TYPE,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    GLO.DIC_IMP_FREE1_ID,
    GLO.DIC_IMP_FREE2_ID,
    GLO.DIC_IMP_FREE3_ID,
    GLO.DIC_IMP_FREE4_ID,
    GLO.DIC_IMP_FREE5_ID,
    GLO.DOC_RECORD_ID,
    GLO.FAM_FIXED_ASSETS_ID,
    GLO.GCO_GOOD_ID,
    GLO.PAC_PERSON_ID,
    GLO.HRM_PERSON_ID,
    GLO.IMF_NUMBER,
    GLO.IMF_NUMBER2,
    GLO.IMF_NUMBER3,
    GLO.IMF_NUMBER4,
    GLO.IMF_NUMBER5,
    GLO.IMF_TEXT1,
    GLO.IMF_TEXT2,
    GLO.IMF_TEXT3,
    GLO.IMF_TEXT4,
    GLO.IMF_TEXT5,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    FYE.FYE_START_DATE  FYE_START_DATE,
    FYE.FYE_END_DATE FYE_END_DATE,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    NULL DOC_DATE_DELIVERY,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    NULL JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION         DES,
    ACS_FINANCIAL_YEAR      FYE,
    ACS_PERIOD              PER,
    ACB_PERIOD_AMOUNT       PERB,
    ACB_GLOBAL_BUDGET       GLO,
    ACB_BUDGET_VERSION      VER,
    ACB_BUDGET              BUD,
    ACS_ACCOUNT             ACC,
    ACS_FINANCIAL_ACCOUNT   FIN
WHERE
    FYE.FYE_NO_EXERCICE           = TO_NUMBER(PROCPARAM_0) AND
    FYE.ACS_FINANCIAL_YEAR_ID     = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID             = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT               = 1 AND
    VER.ACB_BUDGET_VERSION_ID     = GLO.ACB_BUDGET_VERSION_ID AND
    ACC.ACC_NUMBER                >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID            = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID  = GLO.ACS_FINANCIAL_ACCOUNT_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID      = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID            = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID     = FYE.ACS_FINANCIAL_YEAR_ID AND
    (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||GLO.ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null) AND
    ACC.ACS_ACCOUNT_ID            = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID                = VPC_LANG_ID
UNION ALL
SELECT
    'VIDE' INFO,
    NULL ACT_FINANCIAL_IMPUTATION_ID,
    FIN.ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    NULL ACC_NUMBER_CE,
    NULL IMF_TRANSACTION_DATE,
    NULL IMF_VALUE_DATE,
    NULL IMF_DESCRIPTION,
    0 ACS_DIVISION_ACCOUNT_ID,
    NULL DIV_NUMBER,
    NULL DIV_DESCR,
    0 ACS_TAX_CODE_ID,
    NULL TAX_NUMBER,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMF_EXCHANGE_RATE,
    0 IMF_AMOUNT_LC_D,
    0 IMF_AMOUNT_LC_C,
    0 IMF_AMOUNT_FC_D,
    0 IMF_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    'MAN' IMF_TYPE,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    NULL DOC_RECORD_ID,
    NULL FAM_FIXED_ASSETS_ID,
    NULL GCO_GOOD_ID,
    NULL PAC_PERSON_ID,
    NULL HRM_PERSON_ID,
    NULL IMF_NUMBER,
    NULL IMF_NUMBER2,
    NULL IMF_NUMBER3,
    NULL IMF_NUMBER4,
    NULL IMF_NUMBER5,
    NULL IMF_TEXT1,
    NULL IMF_TEXT2,
    NULL IMF_TEXT3,
    NULL IMF_TEXT4,
    NULL IMF_TEXT5,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL FYE_START_DATE,
    NULL FYE_END_DATE,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    NULL DOC_DATE_DELIVERY,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    NULL JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION       DES,
    ACS_FINANCIAL_ACCOUNT FIN,
    ACS_ACCOUNT           ACC
WHERE
    ACC.ACC_NUMBER      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER      <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID   = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
    ACC.ACS_ACCOUNT_ID   = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID       = VPC_LANG_ID AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  FYE,
                    ACS_PERIOD          PER,
                    ACT_FINANCIAL_IMPUTATION  IMP
                WHERE   FYE.FYE_NO_EXERCICE           = TO_NUMBER(PROCPARAM_0) AND
                        FYE.ACS_FINANCIAL_YEAR_ID     = PER.ACS_FINANCIAL_YEAR_ID AND
                        IMP.ACS_PERIOD_ID             = PER.ACS_PERIOD_ID AND
                        IMP.ACS_FINANCIAL_ACCOUNT_ID  = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
                         ((PARAMETER_12 = 0 AND PER.C_TYPE_PERIOD <> 1) OR PARAMETER_12 = 1)) AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR              FYE,
                    ACS_PERIOD                      PER,
                    ACT_TOTAL_BY_PERIOD              TOT
               WHERE   FYE.FYE_NO_EXERCICE           = TO_NUMBER(PROCPARAM_0) AND
                       FYE.ACS_FINANCIAL_YEAR_ID     = PER.ACS_FINANCIAL_YEAR_ID AND
                       TOT.ACS_PERIOD_ID             = PER.ACS_PERIOD_ID AND
                       TOT.ACS_FINANCIAL_ACCOUNT_ID  = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
                       ((PARAMETER_12 = 0 AND PER.C_TYPE_PERIOD <> 1) OR PARAMETER_12 = 1))
                       ) IMP_TOT,
    (SELECT DISTINCT
     FIN_NUMBER,
     COUNT(DISTINCT ACS_FINANCIAL_CURRENCY_ID) CURRENCY_NO
     FROM
     (
SELECT
    'REEL' INFO,
    IMP.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    (SELECT ACC.ACC_NUMBER
      FROM ACS_ACCOUNT               ACC,
           ACT_FINANCIAL_IMPUTATION  IMC
      WHERE IMC.ACT_FINANCIAL_IMPUTATION_ID = ACR_FUNCTIONS.GetFinancialImputationId(IMP.ACT_FINANCIAL_IMPUTATION_ID) AND
            IMC.ACS_FINANCIAL_ACCOUNT_ID    = ACC.ACS_ACCOUNT_ID) ACC_NUMBER_CE,
    IMP.IMF_TRANSACTION_DATE IMF_TRANSACTION_DATE,
    IMP.IMF_VALUE_DATE IMF_VALUE_DATE,
    IMP.IMF_DESCRIPTION IMF_DESCRIPTION,
    IMP.IMF_ACS_DIVISION_ACCOUNT_ID ACS_DIVISION_ACCOUNT_ID,
    (SELECT ACD.ACC_NUMBER
      FROM ACS_ACCOUNT ACD
      WHERE ACD.ACS_ACCOUNT_ID = IMP.IMF_ACS_DIVISION_ACCOUNT_ID) DIV_NUMBER,
    (SELECT DED.DES_DESCRIPTION_SUMMARY
      FROM ACS_DESCRIPTION DED
      WHERE DED.ACS_ACCOUNT_ID   = IMP.IMF_ACS_DIVISION_ACCOUNT_ID AND
            DED.PC_LANG_ID       = VPC_LANG_ID) DIV_DESCR,
    IMP.ACS_TAX_CODE_ID ACS_TAX_CODE_ID,
    (SELECT ACV.ACC_NUMBER
      FROM ACS_ACCOUNT ACV
      WHERE ACV.ACS_ACCOUNT_ID = IMP.ACS_TAX_CODE_ID) TAX_NUMBER,
    IMP.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = IMP.ACS_ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    IMP.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = IMP.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_ME,
    IMP.IMF_EXCHANGE_RATE IMF_EXCHANGE_RATE,
    IMP.IMF_AMOUNT_LC_D IMF_AMOUNT_LC_D,
    IMP.IMF_AMOUNT_LC_C IMF_AMOUNT_LC_C,
    IMP.IMF_AMOUNT_FC_D IMF_AMOUNT_FC_D,
    IMP.IMF_AMOUNT_FC_C IMF_AMOUNT_FC_C,
    IMP.ACS_PERIOD_ID ACS_PERIOD_ID,
    IMP.IMF_TYPE IMF_TYPE,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_SHORT_DESCR,
    IMP.DIC_IMP_FREE1_ID DIC_IMP_FREE1_ID,
    IMP.DIC_IMP_FREE2_ID DIC_IMP_FREE2_ID,
    IMP.DIC_IMP_FREE3_ID DIC_IMP_FREE3_ID,
    IMP.DIC_IMP_FREE4_ID DIC_IMP_FREE4_ID,
    IMP.DIC_IMP_FREE5_ID DIC_IMP_FREE5_ID,
    IMP.DOC_RECORD_ID DOC_RECORD_ID,
    IMP.FAM_FIXED_ASSETS_ID FAM_FIXED_ASSETS_ID,
    IMP.GCO_GOOD_ID GCO_GOOD_ID,
    IMP.PAC_PERSON_ID PAC_PERSON_ID,
    IMP.HRM_PERSON_ID HRM_PERSON_ID,
    IMP.IMF_NUMBER IMF_NUMBER,
    IMP.IMF_NUMBER2 IMF_NUMBER2,
    IMP.IMF_NUMBER3 IMF_NUMBER3,
    IMP.IMF_NUMBER4 IMF_NUMBER4,
    IMP.IMF_NUMBER5 IMF_NUMBER5,
    IMP.IMF_TEXT1 IMF_TEXT1,
    IMP.IMF_TEXT2 IMF_TEXT2,
    IMP.IMF_TEXT3 IMF_TEXT3,
    IMP.IMF_TEXT4 IMF_TEXT4,
    IMP.IMF_TEXT5 IMF_TEXT5,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    FYE.FYE_START_DATE  FYE_START_DATE,
    FYE.FYE_END_DATE FYE_END_DATE,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    (SELECT PAR.DOC_DATE_DELIVERY
      FROM ACT_PART_IMPUTATION PAR
      WHERE PAR.ACT_PART_IMPUTATION_ID = IMP.ACT_PART_IMPUTATION_ID) DOC_DATE_DELIVERY,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
      FROM ACT_ETAT_JOURNAL ETA
      WHERE ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
            ETA.C_SUB_SET      = 'ACC') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
      FROM ACJ_SUB_SET_CAT SCA
      WHERE SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
            SCA.C_SUB_SET                 = 'ACC') C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION           DES,
    ACT_JOURNAL               JOU,
    ACT_DOCUMENT              DOC,
    ACS_PERIOD                PER,
    ACS_FINANCIAL_YEAR        FYE,
    ACT_FINANCIAL_IMPUTATION  IMP,
    ACS_ACCOUNT               ACC,
    ACS_FINANCIAL_ACCOUNT     FIN
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = ACC.ACS_ACCOUNT_ID AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = IMP.ACS_FINANCIAL_ACCOUNT_ID AND
    FYE.FYE_NO_EXERCICE                 = TO_NUMBER(PROCPARAM_0) AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    IMP.ACS_PERIOD_ID                   = PER.ACS_PERIOD_ID AND
    IMP.ACT_DOCUMENT_ID                 = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_JOURNAL_ID                  = JOU.ACT_JOURNAL_ID AND
   (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||IMP.IMF_ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null) AND
    ACC.ACS_ACCOUNT_ID                  = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID                                   = VPC_LANG_ID
UNION ALL
SELECT
    'REPORT' INFO,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    NULL ACC_NUMBER_CE,
    FYE.FYE_START_DATE IMF_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMF_VALUE_DATE,
    'Report' IMF_DESCRIPTION,
    TOT.ACS_DIVISION_ACCOUNT_ID,
    (SELECT ACD.ACC_NUMBER
      FROM ACS_ACCOUNT ACD
      WHERE ACD.ACS_ACCOUNT_ID = TOT.ACS_DIVISION_ACCOUNT_ID) DIV_NUMBER,
    (SELECT DED.DES_DESCRIPTION_SUMMARY
      FROM ACS_DESCRIPTION DED
      WHERE DED.ACS_ACCOUNT_ID   = TOT.ACS_DIVISION_ACCOUNT_ID AND
            DED.PC_LANG_ID       = VPC_LANG_ID) DIV_DESCR,
    0 ACS_TAX_CODE_ID,
    NULL TAX_NUMBER,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = TOT.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = TOT.ACS_ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_ME,
    0 IMF_EXCHANGE_RATE,
    TOT.TOT_DEBIT_LC IMF_AMOUNT_LC_D,
    TOT.TOT_CREDIT_LC IMF_AMOUNT_LC_C,
    TOT.TOT_DEBIT_FC IMF_AMOUNT_FC_D,
    TOT.TOT_CREDIT_FC IMF_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    'MAN' IMF_TYPE,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    NULL DOC_RECORD_ID,
    NULL FAM_FIXED_ASSETS_ID,
    NULL GCO_GOOD_ID,
    NULL PAC_PERSON_ID,
    NULL HRM_PERSON_ID,
    NULL IMF_NUMBER,
    NULL IMF_NUMBER2,
    NULL IMF_NUMBER3,
    NULL IMF_NUMBER4,
    NULL IMF_NUMBER5,
    NULL IMF_TEXT1,
    NULL IMF_TEXT2,
    NULL IMF_TEXT3,
    NULL IMF_TEXT4,
    NULL IMF_TEXT5,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    FYE.FYE_START_DATE  FYE_START_DATE,
    FYE.FYE_END_DATE FYE_END_DATE,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    NULL DOC_DATE_DELIVERY,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    NULL JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    'OPB' C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION       DES,
    ACS_FINANCIAL_YEAR    FYE,
    ACS_PERIOD            PER,
    ACS_FINANCIAL_ACCOUNT FIN,
    ACS_ACCOUNT           ACC,
    ACT_TOTAL_BY_PERIOD   TOT
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = ACC.ACS_ACCOUNT_ID AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID        = TOT.ACS_FINANCIAL_ACCOUNT_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    TOT.ACS_AUXILIARY_ACCOUNT_ID is null AND
    FYE.FYE_NO_EXERCICE                 = TO_NUMBER(PROCPARAM_0) AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID                   = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD                   = '1' AND
    ((TOT.ACS_DIVISION_ACCOUNT_ID is not null) or (TOT.ACS_DIVISION_ACCOUNT_ID is null and ACR_FUNCTIONS.ExistDivision = 0)) AND
    (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||TOT.ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null) AND
       ACC.ACS_ACCOUNT_ID                  = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID                      = VPC_LANG_ID
UNION ALL
SELECT
    'BUDGET' INFO,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    NULL ACC_NUMBER_CE,
    NULL IMF_TRANSACTION_DATE,
    NULL IMF_VALUE_DATE,
    NULL IMF_DESCRIPTION,
    GLO.ACS_DIVISION_ACCOUNT_ID ACS_DIVISION_ACCOUNT_ID,
    (SELECT ACD.ACC_NUMBER
      FROM ACS_ACCOUNT ACD
      WHERE ACD.ACS_ACCOUNT_ID = GLO.ACS_DIVISION_ACCOUNT_ID) DIV_NUMBER,
    (SELECT DED.DES_DESCRIPTION_SUMMARY
      FROM ACS_DESCRIPTION DED
      WHERE DED.ACS_ACCOUNT_ID    = GLO.ACS_DIVISION_ACCOUNT_ID AND
            DED.PC_LANG_ID        = VPC_LANG_ID) DIV_DESCR,
    0 ACS_TAX_CODE_ID,
    NULL TAX_NUMBER,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
      FROM  PCS.PC_CURR CUB,
            ACS_FINANCIAL_CURRENCY CFB
      WHERE CFB.ACS_FINANCIAL_CURRENCY_ID = GLO.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMF_EXCHANGE_RATE,
    0 IMF_AMOUNT_LC_D,
    0 IMF_AMOUNT_LC_C,
    0 IMF_AMOUNT_FC_D,
    0 IMF_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    'MAN' IMF_TYPE,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    GLO.DIC_IMP_FREE1_ID,
    GLO.DIC_IMP_FREE2_ID,
    GLO.DIC_IMP_FREE3_ID,
    GLO.DIC_IMP_FREE4_ID,
    GLO.DIC_IMP_FREE5_ID,
    GLO.DOC_RECORD_ID,
    GLO.FAM_FIXED_ASSETS_ID,
    GLO.GCO_GOOD_ID,
    GLO.PAC_PERSON_ID,
    GLO.HRM_PERSON_ID,
    GLO.IMF_NUMBER,
    GLO.IMF_NUMBER2,
    GLO.IMF_NUMBER3,
    GLO.IMF_NUMBER4,
    GLO.IMF_NUMBER5,
    GLO.IMF_TEXT1,
    GLO.IMF_TEXT2,
    GLO.IMF_TEXT3,
    GLO.IMF_TEXT4,
    GLO.IMF_TEXT5,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    FYE.FYE_START_DATE  FYE_START_DATE,
    FYE.FYE_END_DATE FYE_END_DATE,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    NULL DOC_DATE_DELIVERY,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    NULL JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION         DES,
    ACS_FINANCIAL_YEAR      FYE,
    ACS_PERIOD              PER,
    ACB_PERIOD_AMOUNT       PERB,
    ACB_GLOBAL_BUDGET       GLO,
    ACB_BUDGET_VERSION      VER,
    ACB_BUDGET              BUD,
    ACS_ACCOUNT             ACC,
    ACS_FINANCIAL_ACCOUNT   FIN
WHERE
    FYE.FYE_NO_EXERCICE           = TO_NUMBER(PROCPARAM_0) AND
    FYE.ACS_FINANCIAL_YEAR_ID     = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID             = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT               = 1 AND
    VER.ACB_BUDGET_VERSION_ID     = GLO.ACB_BUDGET_VERSION_ID AND
    ACC.ACC_NUMBER                >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID            = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
    FIN.ACS_FINANCIAL_ACCOUNT_ID  = GLO.ACS_FINANCIAL_ACCOUNT_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID      = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID            = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID     = FYE.ACS_FINANCIAL_YEAR_ID AND
    (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||GLO.ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null) AND
    ACC.ACS_ACCOUNT_ID            = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID                = VPC_LANG_ID
UNION ALL
SELECT
    'VIDE' INFO,
    NULL ACT_FINANCIAL_IMPUTATION_ID,
    FIN.ACS_FINANCIAL_ACCOUNT_ID,
    ACC.ACC_NUMBER FIN_NUMBER,
    DES.DES_DESCRIPTION_SUMMARY FIN_DESCR,
    DES.DES_DESCRIPTION_LARGE FIN_LARGE_DESCR,
    NULL ACC_NUMBER_CE,
    NULL IMF_TRANSACTION_DATE,
    NULL IMF_VALUE_DATE,
    NULL IMF_DESCRIPTION,
    0 ACS_DIVISION_ACCOUNT_ID,
    NULL DIV_NUMBER,
    NULL DIV_DESCR,
    0 ACS_TAX_CODE_ID,
    NULL TAX_NUMBER,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMF_EXCHANGE_RATE,
    0 IMF_AMOUNT_LC_D,
    0 IMF_AMOUNT_LC_C,
    0 IMF_AMOUNT_FC_D,
    0 IMF_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    'MAN' IMF_TYPE,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    NULL DOC_RECORD_ID,
    NULL FAM_FIXED_ASSETS_ID,
    NULL GCO_GOOD_ID,
    NULL PAC_PERSON_ID,
    NULL HRM_PERSON_ID,
    NULL IMF_NUMBER,
    NULL IMF_NUMBER2,
    NULL IMF_NUMBER3,
    NULL IMF_NUMBER4,
    NULL IMF_NUMBER5,
    NULL IMF_TEXT1,
    NULL IMF_TEXT2,
    NULL IMF_TEXT3,
    NULL IMF_TEXT4,
    NULL IMF_TEXT5,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL FYE_START_DATE,
    NULL FYE_END_DATE,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    NULL DOC_DATE_DELIVERY,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    NULL JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_DESCRIPTION       DES,
    ACS_FINANCIAL_ACCOUNT FIN,
    ACS_ACCOUNT           ACC
WHERE
    ACC.ACC_NUMBER      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER      <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID   = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
    ACC.ACS_ACCOUNT_ID   = DES.ACS_ACCOUNT_ID AND
    DES.PC_LANG_ID       = VPC_LANG_ID AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  FYE,
                    ACS_PERIOD          PER,
                    ACT_FINANCIAL_IMPUTATION  IMP
                WHERE   FYE.FYE_NO_EXERCICE           = TO_NUMBER(PROCPARAM_0) AND
                        FYE.ACS_FINANCIAL_YEAR_ID     = PER.ACS_FINANCIAL_YEAR_ID AND
                        IMP.ACS_PERIOD_ID             = PER.ACS_PERIOD_ID AND
                        IMP.ACS_FINANCIAL_ACCOUNT_ID  = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
                        ((PARAMETER_12 = 0 AND PER.C_TYPE_PERIOD <> 1) OR PARAMETER_12 = 1)) AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR              FYE,
                    ACS_PERIOD                      PER,
                    ACT_TOTAL_BY_PERIOD              TOT
               WHERE   FYE.FYE_NO_EXERCICE           = TO_NUMBER(PROCPARAM_0) AND
                       FYE.ACS_FINANCIAL_YEAR_ID     = PER.ACS_FINANCIAL_YEAR_ID AND
                       TOT.ACS_PERIOD_ID             = PER.ACS_PERIOD_ID AND
                       TOT.ACS_FINANCIAL_ACCOUNT_ID  = FIN.ACS_FINANCIAL_ACCOUNT_ID AND
                      ((PARAMETER_12 = 0 AND PER.C_TYPE_PERIOD <> 1) OR PARAMETER_12 = 1))
                       ) IMP_TOT
     WHERE
     --ACS_FINANCIAL_CURRENCY_ID <> ACS_ACS_FINANCIAL_CURRENCY_ID AND
     ((PARAMETER_5 ='1' AND C_TYPE_CUMUL = 'EXT')
     OR (PARAMETER_6 ='1' AND  C_TYPE_CUMUL ='INT')
     OR (PARAMETER_7 ='1' AND C_TYPE_CUMUL ='PRE')
     OR (PARAMETER_8='1' AND C_TYPE_CUMUL ='ENG')
     OR (C_TYPE_CUMUL IS NULL))
     GROUP BY
     FIN_NUMBER) CYN
WHERE
IMP_TOT.FIN_NUMBER = CYN.FIN_NUMBER;

END ACR_ACC_IMPUTATION_DET_RPT_PK;



PROCEDURE ACR_REC_IMPUTATION_DET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, aACC_NUMBER_From       in     varchar2
, aACC_NUMBER_To         in     varchar2
, aACS_FINANCIAL_YEAR_ID in     varchar2
, PARAMETER_4            in     varchar2
, PARAMETER_5            in     varchar2
, PARAMETER_6            in     varchar2
, PARAMETER_7            in     varchar2
, PARAMETER_8            in     varchar2
, PARAMETER_9            in     varchar2
, PARAMETER_10           in     varchar2
, PARAMETER_12           in     varchar2
, PARAMETER_17           in     varchar2
, PARAMETER_18           in     varchar2
, PARAMETER_19           in     varchar2
, PARAMETER_20           in     varchar2
, PARAMETER_21           in     varchar2
, PROCUSER_LANID         in     pcs.pc_lang.lanid%type
)
is
/*
 @DESCRIPTION
  USED FOR REPORT ACR_REC_IMPUTATION_DET
*/

TMP NUMBER;
PARAM5  VARCHAR2(10);
PARAM6  VARCHAR2(10);
VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;

BEGIN

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);
VPC_LANG_ID:= pcs.PC_I_LIB_SESSION.GetUserLangId;

  if (aACC_NUMBER_From is not null) and (Length(Trim(aACC_NUMBER_From)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER1    := aACC_NUMBER_From;
  else
    ACR_FUNCTIONS.ACC_NUMBER1    := ' ';
  end if;
  if (aACC_NUMBER_To is not null) and (Length(Trim(aACC_NUMBER_To)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER2    := aACC_NUMBER_To;
  end if;
  if (aACS_FINANCIAL_YEAR_ID is not null) and (Length(Trim(aACS_FINANCIAL_YEAR_ID)) > 0) then
    ACR_FUNCTIONS.FIN_YEAR_ID    := aACS_FINANCIAL_YEAR_ID;
  end if;
  if ACS_FUNCTION.GetFirstDivision is not null then
    ACR_FUNCTIONS.EXIST_DIVISION := 1;
  else
    ACR_FUNCTIONS.EXIST_DIVISION := 0;
  end if;

 IF LENGTH(PARAMETER_5) = 1 THEN PARAM5:= '0' || PARAMETER_5;
 ELSE PARAM5 := PARAMETER_5;
 END IF ;


 IF LENGTH(PARAMETER_6) = 1 THEN PARAM6:= '0' || PARAMETER_6;
 ELSE PARAM6 := PARAMETER_6;
 END IF ;

open aRefCursor for
SELECT
    CAT.C_TYPE_CATALOGUE,
    ACC.FIN_COLLECTIVE,
    CRC.PC_CURR_ID,
    CRC2.PC_CURR_ID,
    SUB.ACS_SUB_SET_ID,
    SUB.C_SUB_SET,
    PAY.ACT_DET_PAYMENT_ID,
    PAY.DET_PAIED_LC,
    PAY.DET_PAIED_FC,
    PAY.DET_CHARGES_LC,
    PAY.DET_CHARGES_FC,
    PAY.DET_DISCOUNT_LC,
    PAY.DET_DISCOUNT_FC,
    PAY.DET_DEDUCTION_LC,
    PAY.DET_DEDUCTION_FC,
    DOC.DOC_NUMBER,
    DOC.ACT_DOCUMENT_ID,
    IMP.ACT_PART_IMPUTATION_ID,
    IMP.PAR_DOCUMENT,
    IMP.DOC_DATE_DELIVERY,
    PER.PER_NAME,
    PER.PER_FORENAME,
    PER.PER_ACTIVITY,
    CUR.PC_CURR_ID,
    CUR.CURRENCY,
    CUR2.PC_CURR_ID,
    CUR2.CURRENCY,
    LAN.LANID,
    V_AUX.C_TYPE_ACCOUNT,
    V_AUX.ACC_NUMBER,
    V_AUX.DES_DESCRIPTION_SUMMARY,
    V_AUX.DES_DESCRIPTION_LARGE,
    V_IMP.ACT_FINANCIAL_IMPUTATION_ID,
    V_IMP.IMF_DESCRIPTION,
    V_IMP.IMF_AMOUNT_LC_D,
    V_IMP.IMF_AMOUNT_LC_C,
    V_IMP.IMF_EXCHANGE_RATE,
    V_IMP.IMF_AMOUNT_FC_D,
    V_IMP.IMF_AMOUNT_FC_C,
    V_IMP.IMF_VALUE_DATE,
    V_IMP.IMF_TRANSACTION_DATE,
    V_IMP.ACS_FINANCIAL_CURRENCY_ID,
    V_IMP.ACS_AUXILIARY_ACCOUNT_ID,
    V_IMP.ACT_DET_PAYMENT_ID,
    V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
    V_IMP.ACT_PART_IMPUTATION_ID,
    V_IMP.ACS_DIVISION_ACCOUNT_ID,
    V_IMP.DIV_NUMBER,
    V_IMP.JOU_NUMBER,
    V_IMP.C_ETAT_JOURNAL,
    V_IMP.C_TYPE_CUMUL,
    V_IMP.DOC_DATE_DELIVERY,
    V_IMP.MATCHING,
    PRD.C_TYPE_PERIOD,
    DECODE(NVL(IMP.ACT_PART_IMPUTATION_ID,0),0,
       DECODE(NVL(IMP.ACT_DOCUMENT_ID,0),0,0,1),
       DECODE(ACT_FUNCTIONS.GetAmountOfPartImputation(IMP.ACT_PART_IMPUTATION_ID,1)-
              ACT_FUNCTIONS.GetTotalAmountOfPartImputation(IMP.ACT_PART_IMPUTATION_ID,1),0,1,0)) ctrl_pmt_doc,
    ACS_FUNCTION.GetAuxAccOwnerName(V_IMP.ACS_AUXILIARY_ACCOUNT_ID) G1_PER_NAME,
    ACS_FUNCTION.GetPer_short_Name(V_IMP.ACS_AUXILIARY_ACCOUNT_ID) G1_PER_SHORT_NAME,
    CNY.CURRENCY_NO
    FROM
    ACJ_CATALOGUE_DOCUMENT   CAT,
    ACS_FINANCIAL_ACCOUNT    ACC,
    ACS_FINANCIAL_CURRENCY   CRC,
    ACS_FINANCIAL_CURRENCY   CRC2,
    ACS_SUB_SET              SUB,
    ACT_DET_PAYMENT          PAY,
    ACT_DOCUMENT             DOC,
    ACT_PART_IMPUTATION      IMP,
    ACT_JOB                  JOB,
    PAC_PERSON               PER,
    PCS.PC_CURR              CUR,
    PCS.PC_CURR              CUR2,
    PCS.PC_LANG              LAN,
    V_ACS_AUXILIARY_ACCOUNT  V_AUX,
    V_ACT_REC_IMP_REPORT     V_IMP,
    ACS_PERIOD               PRD,
    THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_17) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST,
    (SELECT DISTINCT
     ACC_NUMBER,
     COUNT(DISTINCT ACS_FINANCIAL_CURRENCY_ID) CURRENCY_NO
     FROM
     V_ACT_REC_IMP_REPORT V_IMP
     WHERE
     ACS_FINANCIAL_CURRENCY_ID <> ACS_ACS_FINANCIAL_CURRENCY_ID
     AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
     OR (PARAMETER_19 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
     OR (PARAMETER_20 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
     OR (PARAMETER_21='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
     GROUP BY
     ACC_NUMBER) CNY
WHERE
V_AUX.ACS_AUXILIARY_ACCOUNT_ID(+) = V_IMP.ACS_AUXILIARY_ACCOUNT_ID
AND V_AUX.ACC_NUMBER = CNY.ACC_NUMBER(+)
AND V_AUX.PC_LANG_ID = LAN.PC_LANG_ID
AND V_AUX.ACS_SUB_SET_ID = SUB.ACS_SUB_SET_ID
AND V_IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = ACC.ACS_FINANCIAL_ACCOUNT_ID
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = CRC.ACS_FINANCIAL_CURRENCY_ID
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = CRC2.ACS_FINANCIAL_CURRENCY_ID
AND V_IMP.ACT_DET_PAYMENT_ID = PAY.ACT_DET_PAYMENT_ID(+)
AND V_IMP.ACT_PART_IMPUTATION_ID = IMP.ACT_PART_IMPUTATION_ID(+)
AND DOC.ACT_JOB_ID = JOB.ACT_JOB_ID(+)
AND DOC.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND CRC.PC_CURR_ID = CUR.PC_CURR_ID(+)
AND CRC2.PC_CURR_ID = CUR2.PC_CURR_ID(+)
AND IMP.PAC_CUSTOM_PARTNER_ID = PER.PAC_PERSON_ID(+)
AND V_IMP.ACS_PERIOD_ID = PRD.ACS_PERIOD_ID
AND ((PARAMETER_7 = '1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_8 = '1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
    OR (PARAMETER_9 = '1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND (PARAMETER_17 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_19 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_20 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_21='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
AND LAN.PC_LANG_ID = VPC_LANG_ID
AND ACC.FIN_COLLECTIVE = 1
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(PARAMETER_4|| PARAM5 ||PARAM6,'yyyyMMdd')
AND DECODE(PARAMETER_10,0,SUB.C_SUB_SET,SUB.ACS_SUB_SET_ID) = DECODE(PARAMETER_10,0,'REC',PARAMETER_10)
AND (PARAMETER_12 ='1' OR NOT(PARAMETER_12 = '0'AND V_IMP.MATCHING = 1))
;
END ACR_REC_IMPUTATION_DET_RPT_PK;


PROCEDURE ACT_DET_PAYMENT_SUB_RPT_PK (
  aRefCursor    in out CRYSTAL_CURSOR_TYPES.DualCursorTyp,
  PARAMETER_0   in     NUMBER
)
is
/**
*DESCRIPTION
USED FOR REPORT ACR_REC_IMPUTATION_DET, THE SUB REPORT OF REPORT ACR_REC_IMPUTATION_DET,ACR_PAY_IMPUTATION_DET.
*/
BEGIN
open aRefCursor for
SELECT
FIN.PC_CURR_ID,
FIN.FIN_LOCAL_CURRENCY,
PAY.ACT_PART_IMPUTATION_ID,
PAY.DET_PAIED_LC,
PAY.DET_PAIED_FC,
PAY.DET_CHARGES_LC,
PAY.DET_CHARGES_FC,
PAY.DET_DISCOUNT_LC,
PAY.DET_DISCOUNT_FC,
PAY.DET_DEDUCTION_LC,
PAY.DET_DEDUCTION_FC,
PAY.DET_DIFF_EXCHANGE,
DOC.DOC_NUMBER,
IMP.PAR_DOCUMENT
FROM
    ACS_FINANCIAL_CURRENCY FIN,
	ACT_DET_PAYMENT        PAY,
	ACT_DOCUMENT           DOC,
	ACT_PART_IMPUTATION    IMP,
	ACT_EXPIRY             EXP
WHERE
PAY.ACT_EXPIRY_ID = EXP.ACT_EXPIRY_ID
AND EXP.ACT_PART_IMPUTATION_ID = IMP.ACT_PART_IMPUTATION_ID
AND IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID
AND IMP.ACS_FINANCIAL_CURRENCY_ID = FIN.ACS_FINANCIAL_CURRENCY_ID
AND PAY.ACT_PART_IMPUTATION_ID = PARAMETER_0
;
END ACT_DET_PAYMENT_SUB_RPT_PK;

PROCEDURE ACT_DET_PAYMENT_LET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PARAMETER_0 in     NUMBER
)
is
/**
*DESCRIPTION
USED FOR REPORT ACT_DET_PAYMENT_LETTRAGE, THE SUB REPORT OF REPORT ACR_REC_IMPUTATION_DET,ACR_PAY_IMPUTATION_DET.
*/
BEGIN
open aRefCursor for
SELECT
FIN.PC_CURR_ID,
IMP.IMF_TYPE,
IMP.IMF_AMOUNT_LC_D,
IMP.IMF_AMOUNT_LC_C,
IMP.IMF_AMOUNT_FC_D,
IMP.IMF_AMOUNT_FC_C,
IMP.ACT_DET_PAYMENT_ID,
IMP.ACS_FINANCIAL_CURRENCY_ID,
IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
IMP.C_GENRE_TRANSACTION,
IMP.ACT_PART_IMPUTATION_ID
FROM
    ACS_FINANCIAL_CURRENCY     FIN,
	ACT_FINANCIAL_IMPUTATION   IMP
WHERE
IMP.C_GENRE_TRANSACTION = '1'
AND (IMP.ACT_DET_PAYMENT_ID IS NULL)
AND IMP.IMF_TYPE <> 'VAT'
AND IMP.ACT_PART_IMPUTATION_ID = PARAMETER_0
;
END ACT_DET_PAYMENT_LET_RPT_PK;


PROCEDURE ACR_FIN_IMP_CUMUL_REC_RPT_PK (
  aRefCursor    in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, date_to       in     VARCHAR2
, PARAMETER_0   in     NUMBER
, PARAMETER_7   in     VARCHAR2
, PARAMETER_8   in     VARCHAR2
, PARAMETER_9   in     VARCHAR2
, PARAMETER_12  in     VARCHAR2
, PARAMETER_17   in    VARCHAR2 -- Division list
, PARAMETER_18  in     VARCHAR2
, PARAMETER_19  in     VARCHAR2
, PARAMETER_20  in     VARCHAR2
, PARAMETER_21  in     VARCHAR2
)
is
/**
*DESCRIPTION
USED FOR REPORT V_ACT_FINANCIAL_IMPUTATION_CUMUL
*/
BEGIN
open aRefCursor for
SELECT
CAT.C_TYPE_CATALOGUE,
FIN.FIN_COLLECTIVE,
CUR.FIN_LOCAL_CURRENCY,
PCR.CURRENCY,
PCR2.CURRENCY CURRENCY_LC,
V_IMP.IMF_AMOUNT_LC_D,
V_IMP.IMF_AMOUNT_LC_C,
V_IMP.IMF_AMOUNT_FC_D,
V_IMP.IMF_AMOUNT_FC_C,
V_IMP.IMF_TRANSACTION_DATE,
V_IMP.ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACS_AUXILIARY_ACCOUNT_ID,
V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.C_ETAT_JOURNAL,
V_IMP.ACT_FINANCIAL_IMPUTATION_ID,
PRD.C_TYPE_PERIOD
FROM
    ACJ_CATALOGUE_DOCUMENT CAT,
    ACS_AUX_ACCOUNT_S_FIN_CURR AUX,
    ACS_FINANCIAL_ACCOUNT FIN,
    ACS_FINANCIAL_CURRENCY CUR,
    ACS_FINANCIAL_CURRENCY CUL,
    ACT_DOCUMENT DOC,
    PCS.PC_CURR PCR,
    PCS.PC_CURR PCR2,
    V_ACT_REC_IMP_REPORT V_IMP,
    ACS_PERIOD PRD,
    THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_17) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST,
    ACS_AUX_ACCOUNT_S_FIN_CURR AUX_S
WHERE
V_IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID(+)
AND DOC.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = FIN.ACS_FINANCIAL_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = CUR.ACS_FINANCIAL_CURRENCY_ID(+)
AND CUR.PC_CURR_ID = PCR.PC_CURR_ID(+)
AND V_IMP.ACS_AUXILIARY_ACCOUNT_ID = AUX.ACS_AUXILIARY_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = AUX.ACS_FINANCIAL_CURRENCY_ID(+)
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = CUL.ACS_FINANCIAL_CURRENCY_ID(+)
AND CUL.PC_CURR_ID = PCR2.PC_CURR_ID
AND FIN.FIN_COLLECTIVE = 1
AND V_IMP.ACS_PERIOD_ID = PRD.ACS_PERIOD_ID
AND AUX_S.ACS_AUXILIARY_ACCOUNT_ID = V_IMP.ACS_AUXILIARY_ACCOUNT_ID
AND AUX_S.ACS_FINANCIAL_CURRENCY_ID = V_IMP.ACS_FINANCIAL_CURRENCY_ID
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(date_to,'yyyyMMdd')
AND (PARAMETER_17 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND ((PARAMETER_7='1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_8='1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
    OR (PARAMETER_9='1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
     OR (PARAMETER_19 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
     OR (PARAMETER_20 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
     OR (PARAMETER_21='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
AND ((PARAMETER_12 = '1')
    OR((PARAMETER_12 <>'1') AND (CAT.C_TYPE_CATALOGUE IS NULL))
    OR((PARAMETER_12 <>'1') AND NOT(CAT.C_TYPE_CATALOGUE IS NULL) AND CAT.C_TYPE_CATALOGUE <>'9'))
AND V_IMP.ACS_AUXILIARY_ACCOUNT_ID = PARAMETER_0
;
END ACR_FIN_IMP_CUMUL_REC_RPT_PK ;

PROCEDURE ACR_PAY_IMPUTATION_DET_RPT_PK (
  aRefCursor             in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, aACC_NUMBER_From       in     varchar2
, aACC_NUMBER_To         in     varchar2
, aACS_FINANCIAL_YEAR_ID in     varchar2
, PARAMETER_4            in     varchar2
, PARAMETER_5            in     varchar2
, PARAMETER_6            in     varchar2
, PARAMETER_7            in     varchar2
, PARAMETER_8            in     varchar2
, PARAMETER_9            in     varchar2
, PARAMETER_10           in     varchar2
, PARAMETER_12           in     varchar2
, PARAMETER_17           in     varchar2
, PARAMETER_18           in     varchar2
, PARAMETER_19           in     varchar2
, PARAMETER_20           in     varchar2
, PARAMETER_21           in     varchar2
, PROCUSER_LANID         in     pcs.pc_lang.lanid%type
)
is
/**
*DESCRIPTION
USED FOR REPORT ACR_PAY_IMPUTATION_DET
*/


TMP NUMBER;
PARAM5 VARCHAR2(10); -- MOIS
PARAM6 VARCHAR2(10); -- JOUR
VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;

BEGIN

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);
VPC_LANG_ID:= pcs.PC_I_LIB_SESSION.GetUserLangId;

  if (aACC_NUMBER_From is not null) and (Length(Trim(aACC_NUMBER_From)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER1    := aACC_NUMBER_From;
  else
    ACR_FUNCTIONS.ACC_NUMBER1    := ' ';
  end if;
  if (aACC_NUMBER_To is not null) and (Length(Trim(aACC_NUMBER_To)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER2    := aACC_NUMBER_To;
  end if;
  if (aACS_FINANCIAL_YEAR_ID is not null) and (Length(Trim(aACS_FINANCIAL_YEAR_ID)) > 0) then
    ACR_FUNCTIONS.FIN_YEAR_ID    := aACS_FINANCIAL_YEAR_ID;
  end if;
  if ACS_FUNCTION.GetFirstDivision is not null then
    ACR_FUNCTIONS.EXIST_DIVISION := 1;
  else
    ACR_FUNCTIONS.EXIST_DIVISION := 0;
  end if;

 IF LENGTH(PARAMETER_5) = 1 THEN PARAM5:= '0' || PARAMETER_5;
 ELSE PARAM5 := PARAMETER_5;
 END IF ;

 IF LENGTH(PARAMETER_6) = 1 THEN PARAM6:= '0' || PARAMETER_6;
 ELSE PARAM6 := PARAMETER_6;
 END IF ;

open aRefCursor for
SELECT
    CAT.C_TYPE_CATALOGUE,
    ACC.FIN_COLLECTIVE,
    CRC.PC_CURR_ID,
    CRC2.PC_CURR_ID,
    SUB.ACS_SUB_SET_ID,
    SUB.C_SUB_SET,
    PAY.ACT_DET_PAYMENT_ID,
    PAY.DET_PAIED_LC,
    PAY.DET_PAIED_FC,
    PAY.DET_CHARGES_LC,
    PAY.DET_CHARGES_FC,
    PAY.DET_DISCOUNT_LC,
    PAY.DET_DISCOUNT_FC,
    PAY.DET_DEDUCTION_LC,
    PAY.DET_DEDUCTION_FC,
    DOC.DOC_NUMBER,
    DOC.ACT_DOCUMENT_ID,
    IMP.ACT_PART_IMPUTATION_ID,
    IMP.PAR_DOCUMENT,
    IMP.DOC_DATE_DELIVERY,
    PER.PER_NAME,
    PER.PER_FORENAME,
    PER.PER_ACTIVITY,
    CUR.PC_CURR_ID,
    CUR.CURRENCY,
    CUR2.PC_CURR_ID,
    CUR2.CURRENCY,
    LAN.LANID,
    V_AUX.C_TYPE_ACCOUNT,
    V_AUX.ACC_NUMBER,
    V_AUX.DES_DESCRIPTION_SUMMARY,
    V_AUX.DES_DESCRIPTION_LARGE,
    V_IMP.ACT_FINANCIAL_IMPUTATION_ID,
    V_IMP.IMF_DESCRIPTION,
    V_IMP.IMF_AMOUNT_LC_D,
    V_IMP.IMF_AMOUNT_LC_C,
    V_IMP.IMF_EXCHANGE_RATE,
    V_IMP.IMF_AMOUNT_FC_D,
    V_IMP.IMF_AMOUNT_FC_C,
    V_IMP.IMF_VALUE_DATE,
    V_IMP.IMF_TRANSACTION_DATE,
    V_IMP.ACS_FINANCIAL_CURRENCY_ID,
    V_IMP.ACS_AUXILIARY_ACCOUNT_ID,
    V_IMP.ACT_DET_PAYMENT_ID,
    V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
    V_IMP.ACT_PART_IMPUTATION_ID,
    V_IMP.ACS_DIVISION_ACCOUNT_ID,
    V_IMP.DIV_NUMBER,
    V_IMP.JOU_NUMBER,
    V_IMP.C_ETAT_JOURNAL,
    V_IMP.C_TYPE_CUMUL,
    V_IMP.MATCHING,
    PRD.C_TYPE_PERIOD,
    CNY.CURRENCY_NO,
    DECODE(NVL(IMP.ACT_PART_IMPUTATION_ID,0),0,
    DECODE(NVL(IMP.ACT_DOCUMENT_ID,0),0,0,1),
            DECODE(ACT_FUNCTIONS.GetAmountOfPartImputation(IMP.ACT_PART_IMPUTATION_ID,1)-
              ACT_FUNCTIONS.GetTotalAmountOfPartImputation(IMP.ACT_PART_IMPUTATION_ID,1),0,1,0)) ctrl_pmt_doc,
    ACS_FUNCTION.GetAuxAccOwnerName(V_IMP.ACS_AUXILIARY_ACCOUNT_ID) G1_PER_NAME,
    ACS_FUNCTION.GetPer_short_Name(V_IMP.ACS_AUXILIARY_ACCOUNT_ID) G1_PER_SHORT_NAME
FROM
    ACJ_CATALOGUE_DOCUMENT   CAT,
    ACS_FINANCIAL_ACCOUNT    ACC,
    ACS_FINANCIAL_CURRENCY   CRC,
    ACS_FINANCIAL_CURRENCY   CRC2,
    ACS_SUB_SET              SUB,
    ACT_DET_PAYMENT          PAY,
    ACT_DOCUMENT             DOC,
    ACT_PART_IMPUTATION      IMP,
    ACT_JOB                  JOB,
    PAC_PERSON               PER,
    PCS.PC_CURR              CUR,
    PCS.PC_CURR              CUR2,
    PCS.PC_LANG              LAN,
    V_ACS_AUXILIARY_ACCOUNT  V_AUX,
    V_ACT_PAY_IMP_REPORT     V_IMP,
    ACS_PERIOD               PRD,
    THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_17) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST,
    (SELECT DISTINCT
     ACC_NUMBER,
     COUNT(DISTINCT ACS_FINANCIAL_CURRENCY_ID) CURRENCY_NO
     FROM
     V_ACT_PAY_IMP_REPORT V_IMP
     WHERE
     ACS_FINANCIAL_CURRENCY_ID <> ACS_ACS_FINANCIAL_CURRENCY_ID
     AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
     OR (PARAMETER_19 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
     OR (PARAMETER_20 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
     OR (PARAMETER_21='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
     GROUP BY
     ACC_NUMBER) CNY
WHERE
V_AUX.ACS_AUXILIARY_ACCOUNT_ID = V_IMP.ACS_AUXILIARY_ACCOUNT_ID
AND V_AUX.ACC_NUMBER = CNY.ACC_NUMBER(+)
AND V_AUX.PC_LANG_ID = LAN.PC_LANG_ID
AND V_AUX.ACS_SUB_SET_ID = SUB.ACS_SUB_SET_ID
AND V_IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = ACC.ACS_FINANCIAL_ACCOUNT_ID
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = CRC.ACS_FINANCIAL_CURRENCY_ID
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = CRC2.ACS_FINANCIAL_CURRENCY_ID
AND V_IMP.ACT_DET_PAYMENT_ID = PAY.ACT_DET_PAYMENT_ID(+)
AND V_IMP.ACT_PART_IMPUTATION_ID = IMP.ACT_PART_IMPUTATION_ID(+)
AND DOC.ACT_JOB_ID = JOB.ACT_JOB_ID(+)
AND DOC.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND CRC.PC_CURR_ID = CUR.PC_CURR_ID(+)
AND CRC2.PC_CURR_ID = CUR2.PC_CURR_ID(+)
AND IMP.PAC_SUPPLIER_PARTNER_ID = PER.PAC_PERSON_ID(+)
AND V_IMP.ACS_PERIOD_ID = PRD.ACS_PERIOD_ID
AND ((PARAMETER_7 = '1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_8 = '1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
    OR (PARAMETER_9 = '1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND (PARAMETER_17 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_19 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_20 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_21='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
AND LAN.PC_LANG_ID = VPC_LANG_ID
AND ACC.FIN_COLLECTIVE = 1
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(PARAMETER_4|| PARAM5 ||PARAM6,'yyyyMMdd')
AND DECODE(PARAMETER_10,0,SUB.C_SUB_SET,SUB.ACS_SUB_SET_ID) = DECODE(PARAMETER_10,0,'PAY',PARAMETER_10)
AND (PARAMETER_12 ='1' OR NOT(PARAMETER_12 = '0'AND V_IMP.MATCHING = 1))
;
end ACR_PAY_IMPUTATION_DET_RPT_PK;

PROCEDURE ACR_FIN_IMP_CUMUL_PAY_RPT_PK (
  aRefCursor    in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, date_to       in     VARCHAR2
, PARAMETER_0   in     NUMBER
, PARAMETER_7   in     VARCHAR2
, PARAMETER_8   in     VARCHAR2
, PARAMETER_9   in     VARCHAR2
, PARAMETER_12  in     VARCHAR2
, PARAMETER_17  in      VARCHAR2 -- Division list
, PARAMETER_18   in     VARCHAR2
, PARAMETER_19   in     VARCHAR2
, PARAMETER_20   in     VARCHAR2
, PARAMETER_21   in     VARCHAR2
)
is
/**
*DESCRIPTION
USED FOR REPORT V_ACT_FINANCIAL_IMPUTATION_CUMUL
*/
BEGIN
open aRefCursor for
SELECT
CAT.C_TYPE_CATALOGUE,
CUR.ACS_FINANCIAL_CURRENCY_ID,
FIN.FIN_COLLECTIVE,
CUR.FIN_LOCAL_CURRENCY,
PCR.CURRENCY,
PCR2.CURRENCY CURRENCY_LC,
V_IMP.IMF_AMOUNT_LC_D,
V_IMP.IMF_AMOUNT_LC_C,
V_IMP.IMF_AMOUNT_FC_D,
V_IMP.IMF_AMOUNT_FC_C,
V_IMP.IMF_TRANSACTION_DATE,
V_IMP.ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACS_AUXILIARY_ACCOUNT_ID,
V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.C_ETAT_JOURNAL,
V_IMP.ACT_FINANCIAL_IMPUTATION_ID,
PRD.C_TYPE_PERIOD
FROM
	ACJ_CATALOGUE_DOCUMENT CAT,
	ACS_AUX_ACCOUNT_S_FIN_CURR AUX,
	ACS_FINANCIAL_ACCOUNT FIN,
	ACS_FINANCIAL_CURRENCY CUR,
	ACS_FINANCIAL_CURRENCY CUL,
	ACT_DOCUMENT DOC,
	PCS.PC_CURR PCR,
	PCS.PC_CURR PCR2,
	V_ACT_PAY_IMP_REPORT V_IMP,
	ACS_PERIOD PRD,
	ACS_AUX_ACCOUNT_S_FIN_CURR AUX_S,
    THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_17) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST
WHERE
V_IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID(+)
AND DOC.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = FIN.ACS_FINANCIAL_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = CUR.ACS_FINANCIAL_CURRENCY_ID(+)
AND CUR.ACS_FINANCIAL_CURRENCY_ID = PCR.PC_CURR_ID(+)
AND V_IMP.ACS_AUXILIARY_ACCOUNT_ID = AUX.ACS_AUXILIARY_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = AUX.ACS_FINANCIAL_CURRENCY_ID(+)
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = CUL.ACS_FINANCIAL_CURRENCY_ID(+)
AND CUL.PC_CURR_ID = PCR2.PC_CURR_ID
AND FIN.FIN_COLLECTIVE = 1
AND PRD.ACS_PERIOD_ID = V_IMP.ACS_PERIOD_ID
AND AUX_S.ACS_AUXILIARY_ACCOUNT_ID = V_IMP.ACS_AUXILIARY_ACCOUNT_ID
AND AUX_S.ACS_FINANCIAL_CURRENCY_ID = V_IMP.ACS_FINANCIAL_CURRENCY_ID
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(date_to,'yyyyMMdd')
AND (PARAMETER_17 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND ((PARAMETER_7='1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_8='1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
	OR (PARAMETER_9='1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_19 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_20 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_21='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
AND ((PARAMETER_12 = '1')
    OR((PARAMETER_12 <>'1') AND (CAT.C_TYPE_CATALOGUE IS NULL))
    OR((PARAMETER_12 <>'1') AND NOT(CAT.C_TYPE_CATALOGUE IS NULL) AND CAT.C_TYPE_CATALOGUE <>'9'))
AND V_IMP.ACS_AUXILIARY_ACCOUNT_ID = PARAMETER_0
;
END ACR_FIN_IMP_CUMUL_PAY_RPT_PK;

PROCEDURE ACT_ACC_IMP_ME_SUB_1_RPT_PK (
  aRefCursor     in out CRYSTAL_CURSOR_TYPES.DualCursorTyp,
  PROCPARAM_0    in number,
  P_ACS_FINANCIAL_ACCOUNT_ID in number,
  PROCPARAM_3    in varchar2,
  PARAMETER_0    in varchar2,
  PARAMETER_1    in varchar2,
  PARAMETER_2    in varchar2,
  PARAMETER_3    in varchar2,
  PARAMETER_4    in varchar2,
  PARAMETER_5    in varchar2,
  PARAMETER_6    in varchar2,
  PARAMETER_7    in varchar2,
  PARAMETER_8    in varchar2,
  PARAMETER_12   in varchar2,
  PARAMETER_13   in varchar2
)
is
/**
/**
*DESCRIPTION
USED FOR REPORT ACT_ACC_IMP_ME_1 AND ACT_ACC_IMP_ME_2, THE SUB REPORT OF ACR_ACC_IMPUTATION_DET.RPT
*/
BEGIN
open aRefCursor for
SELECT
'REEL' info,
 imp.imf_transaction_date imf_transaction_date,
 imp.imf_amount_lc_d imf_amount_lc_d,
 imp.imf_amount_lc_c imf_amount_lc_c,
 imp.imf_amount_fc_d imf_amount_fc_d,
 imp.imf_amount_fc_c imf_amount_fc_c,
 imp.acs_acs_financial_currency_id acs_acs_financial_currency_id,
 acs_function.getcurrencyname(imp.acs_acs_financial_currency_id) currency_mb,
 imp.acs_financial_currency_id acs_financial_currency_id,
 acs_function.getcurrencyname(imp.acs_financial_currency_id) currency_me,
 imp.acs_financial_account_id acs_financial_account_id,
 imp.imf_acs_division_account_id acs_division_account_id,
 imp.acs_tax_code_id acs_tax_code_id,
 fye.fye_no_exercice fye_no_exercice,
 /*(SELECT eta.c_etat_journal
  FROM act_etat_journal eta
  WHERE eta.act_journal_id = jou.act_journal_id
  AND eta.c_sub_set = 'ACC') c_etat_journal,*/
 eta.C_ETAT_JOURNAL,
 /*(SELECT sca.c_type_cumul
  FROM acj_sub_set_cat sca
  WHERE sca.acj_catalogue_document_id = doc.acj_catalogue_document_id
        AND sca.c_sub_set = 'ACC') c_type_cumul*/
 sca.C_TYPE_CUMUL
FROM
act_journal jou,
act_etat_journal eta,
acj_sub_set_cat sca,
act_document doc,
acs_period per,
acs_financial_year fye,
act_financial_imputation imp
WHERE
imp.acs_period_id = per.acs_period_id
AND per.acs_financial_year_id = fye.acs_financial_year_id
AND imp.act_document_id = doc.act_document_id
AND doc.act_journal_id = jou.act_journal_id
AND eta.act_journal_id = jou.act_journal_id
AND eta.c_sub_set = 'ACC'
AND sca.acj_catalogue_document_id = doc.acj_catalogue_document_id
AND sca.c_sub_set = 'ACC'
AND (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||IMP.IMF_ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null)
AND ((PARAMETER_12 = '1'AND imp.imf_transaction_date <= TO_DATE(PARAMETER_1,'yyyyMMdd'))
    OR (PARAMETER_12 = '0' AND imp.imf_transaction_date >= TO_DATE(PARAMETER_0,'yyyyMMdd') AND imp.imf_transaction_date <= TO_DATE(PARAMETER_1,'yyyyMMdd')))
AND ((PARAMETER_2 = '1' AND  eta.C_ETAT_JOURNAL ='BRO')
    OR (PARAMETER_3 = '1' AND  eta.C_ETAT_JOURNAL ='PROV')
    OR (PARAMETER_4 = '1' AND  eta.C_ETAT_JOURNAL ='DEF'))
AND ((PARAMETER_5 ='1' AND sca.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_6 ='1' AND  sca.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_7 ='1' AND sca.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_8='1' AND sca.C_TYPE_CUMUL ='ENG'))
AND ((imp.acs_tax_code_id IS NULL) AND PARAMETER_13 = '1'
    OR PARAMETER_13 = '0' )
AND IMP.ACS_FINANCIAL_ACCOUNT_ID = P_ACS_FINANCIAL_ACCOUNT_ID
AND FYE.FYE_NO_EXERCICE = PROCPARAM_0
UNION ALL
SELECT
 'REPORT' info,
 fye.fye_start_date imf_transaction_date,
 tot.tot_debit_lc imf_amount_lc_d,
 tot.tot_credit_lc imf_amount_lc_c,
 tot.tot_debit_fc imf_amount_fc_d,
 tot.tot_credit_fc imf_amount_fc_c,
 tot.acs_financial_currency_id acs_acs_financial_currency_id,
 acs_function.getcurrencyname(tot.acs_financial_currency_id) currency_mb,
 tot.acs_acs_financial_currency_id acs_financial_currency_id,
 acs_function.getcurrencyname (tot.acs_acs_financial_currency_id) currency_me,
 tot.acs_financial_account_id acs_financial_account_id,
 tot.acs_division_account_id acs_division_account_id,
 0 acs_tax_code_id,
 fye.fye_no_exercice fye_no_exercice,
 'PROV' c_etat_journal,
 tot.c_type_cumul c_type_cumul
FROM
acs_period per,
acs_financial_year fye,
act_total_by_period tot
WHERE
tot.acs_period_id = per.acs_period_id
AND per.acs_financial_year_id = fye.acs_financial_year_id
AND acs_function.getstatepreviousfinancialyear(fye.acs_financial_year_id) = 'ACT'
AND tot.acs_auxiliary_account_id IS NULL
AND ((tot.acs_division_account_id IS NOT NULL)
    OR (tot.acs_division_account_id IS NULL
    AND acr_functions.existdivision = 0 ))
AND per.c_type_period = '1'
AND ((TOT.ACS_DIVISION_ACCOUNT_ID is not null) or (TOT.ACS_DIVISION_ACCOUNT_ID is null and ACR_FUNCTIONS.ExistDivision = 0)) AND
    (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||TOT.ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null)
AND PARAMETER_3 ='1'
AND (  (PARAMETER_12 = '1'AND fye.fye_start_date <= TO_DATE(PARAMETER_1,'yyyyMMdd'))
    OR (PARAMETER_12 = '0' AND fye.fye_start_date >= TO_DATE(PARAMETER_0,'yyyyMMdd') AND fye.fye_start_date <= TO_DATE(PARAMETER_1,'yyyyMMdd')))
AND (  (PARAMETER_5 ='1' AND TOT.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_6 ='1' AND  TOT.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_7 ='1' AND TOT.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_8='1' AND TOT.C_TYPE_CUMUL ='ENG'))
AND PARAMETER_13 = '0'
AND TOT.ACS_FINANCIAL_ACCOUNT_ID = P_ACS_FINANCIAL_ACCOUNT_ID
AND FYE.FYE_NO_EXERCICE = PROCPARAM_0
 ;
end ACT_ACC_IMP_ME_SUB_1_RPT_PK;

PROCEDURE ACT_ACC_IMP_ME_SUB_2_RPT_PK (
  aRefCursor     in out CRYSTAL_CURSOR_TYPES.DualCursorTyp,
  PROCPARAM_0    in number,
  P_ACS_FINANCIAL_ACCOUNT_ID in number,
  P_ACS_DIVISION_ACCOUNT_ID  in number,
  PROCPARAM_3    in varchar2,
  PARAMETER_0    in varchar2,
  PARAMETER_1    in varchar2,
  PARAMETER_2    in varchar2,
  PARAMETER_3    in varchar2,
  PARAMETER_4    in varchar2,
  PARAMETER_5    in varchar2,
  PARAMETER_6    in varchar2,
  PARAMETER_7    in varchar2,
  PARAMETER_8    in varchar2,
  PARAMETER_12   in varchar2,
  PARAMETER_13   in varchar2
)
is
/**
/**
*DESCRIPTION
USED FOR REPORT ACT_ACC_IMP_ME_1 AND ACT_ACC_IMP_ME_2, THE SUB REPORT OF ACR_ACC_IMPUTATION_DET.RPT
*/
BEGIN
open aRefCursor for
SELECT
'REEL' info,
 imp.imf_transaction_date imf_transaction_date,
 imp.imf_amount_lc_d imf_amount_lc_d,
 imp.imf_amount_lc_c imf_amount_lc_c,
 imp.imf_amount_fc_d imf_amount_fc_d,
 imp.imf_amount_fc_c imf_amount_fc_c,
 imp.acs_acs_financial_currency_id acs_acs_financial_currency_id,
 acs_function.getcurrencyname(imp.acs_acs_financial_currency_id) currency_mb,
 imp.acs_financial_currency_id acs_financial_currency_id,
 acs_function.getcurrencyname(imp.acs_financial_currency_id) currency_me,
 imp.acs_financial_account_id acs_financial_account_id,
 imp.imf_acs_division_account_id acs_division_account_id,
 imp.acs_tax_code_id acs_tax_code_id,
 fye.fye_no_exercice fye_no_exercice,
 /*(SELECT eta.c_etat_journal
  FROM act_etat_journal eta
  WHERE eta.act_journal_id = jou.act_journal_id
  AND eta.c_sub_set = 'ACC') c_etat_journal,*/
 eta.C_ETAT_JOURNAL,
 /*(SELECT sca.c_type_cumul
  FROM acj_sub_set_cat sca
  WHERE sca.acj_catalogue_document_id = doc.acj_catalogue_document_id
        AND sca.c_sub_set = 'ACC') c_type_cumul*/
 sca.C_TYPE_CUMUL
FROM
act_journal jou,
act_etat_journal eta,
acj_sub_set_cat sca,
act_document doc,
acs_period per,
acs_financial_year fye,
act_financial_imputation imp
WHERE
imp.acs_period_id = per.acs_period_id
AND per.acs_financial_year_id = fye.acs_financial_year_id
AND imp.act_document_id = doc.act_document_id
AND doc.act_journal_id = jou.act_journal_id
AND eta.act_journal_id = jou.act_journal_id
AND eta.c_sub_set = 'ACC'
AND sca.acj_catalogue_document_id = doc.acj_catalogue_document_id
AND sca.c_sub_set = 'ACC'
AND (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||IMP.IMF_ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null)
AND ((PARAMETER_12 = '1'AND imp.imf_transaction_date <= TO_DATE(PARAMETER_1,'yyyyMMdd'))
    OR (PARAMETER_12 = '0' AND imp.imf_transaction_date >= TO_DATE(PARAMETER_0,'yyyyMMdd') AND imp.imf_transaction_date <= TO_DATE(PARAMETER_1,'yyyyMMdd')))
AND ((PARAMETER_2 = '1' AND  eta.C_ETAT_JOURNAL ='BRO')
    OR (PARAMETER_3 = '1' AND  eta.C_ETAT_JOURNAL ='PROV')
    OR (PARAMETER_4 = '1' AND  eta.C_ETAT_JOURNAL ='DEF'))
AND ((PARAMETER_5 ='1' AND sca.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_6 ='1' AND  sca.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_7 ='1' AND sca.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_8='1' AND sca.C_TYPE_CUMUL ='ENG'))
AND ((imp.acs_tax_code_id IS NULL) AND PARAMETER_13 = '1'
    OR PARAMETER_13 = '0' )
AND IMP.ACS_FINANCIAL_ACCOUNT_ID = P_ACS_FINANCIAL_ACCOUNT_ID
AND FYE.FYE_NO_EXERCICE = PROCPARAM_0
AND IMP.IMF_ACS_DIVISION_ACCOUNT_ID = P_ACS_DIVISION_ACCOUNT_ID
UNION ALL
SELECT
 'REPORT' info,
 fye.fye_start_date imf_transaction_date,
 tot.tot_debit_lc imf_amount_lc_d,
 tot.tot_credit_lc imf_amount_lc_c,
 tot.tot_debit_fc imf_amount_fc_d,
 tot.tot_credit_fc imf_amount_fc_c,
 tot.acs_financial_currency_id acs_acs_financial_currency_id,
 acs_function.getcurrencyname(tot.acs_financial_currency_id) currency_mb,
 tot.acs_acs_financial_currency_id acs_financial_currency_id,
 acs_function.getcurrencyname (tot.acs_acs_financial_currency_id) currency_me,
 tot.acs_financial_account_id acs_financial_account_id,
 tot.acs_division_account_id acs_division_account_id,
 0 acs_tax_code_id,
 fye.fye_no_exercice fye_no_exercice,
 'PROV' c_etat_journal,
 tot.c_type_cumul c_type_cumul
FROM
acs_period per,
acs_financial_year fye,
act_total_by_period tot
WHERE
tot.acs_period_id = per.acs_period_id
AND per.acs_financial_year_id = fye.acs_financial_year_id
AND acs_function.getstatepreviousfinancialyear(fye.acs_financial_year_id) = 'ACT'
AND tot.acs_auxiliary_account_id IS NULL
AND ((tot.acs_division_account_id IS NOT NULL)
    OR (tot.acs_division_account_id IS NULL
    AND acr_functions.existdivision = 0 ))
AND per.c_type_period = '1'
AND ((TOT.ACS_DIVISION_ACCOUNT_ID is not null) or (TOT.ACS_DIVISION_ACCOUNT_ID is null and ACR_FUNCTIONS.ExistDivision = 0)) AND
    (INSTR(','||PROCPARAM_3||',', TO_CHAR(','||TOT.ACS_DIVISION_ACCOUNT_ID||',')) > 0 OR PROCPARAM_3 is null)
AND PARAMETER_3 ='1'
AND (  (PARAMETER_12 = '1'AND fye.fye_start_date <= TO_DATE(PARAMETER_1,'yyyyMMdd'))
    OR (PARAMETER_12 = '0' AND fye.fye_start_date >= TO_DATE(PARAMETER_0,'yyyyMMdd') AND fye.fye_start_date <= TO_DATE(PARAMETER_1,'yyyyMMdd')))
AND (  (PARAMETER_5 ='1' AND TOT.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_6 ='1' AND  TOT.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_7 ='1' AND TOT.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_8='1' AND TOT.C_TYPE_CUMUL ='ENG'))
AND PARAMETER_13 = '0'
AND TOT.ACS_FINANCIAL_ACCOUNT_ID = P_ACS_FINANCIAL_ACCOUNT_ID
AND FYE.FYE_NO_EXERCICE = PROCPARAM_0
AND TOT.ACS_DIVISION_ACCOUNT_ID = P_ACS_DIVISION_ACCOUNT_ID
 ;
end ACT_ACC_IMP_ME_SUB_2_RPT_PK;


PROCEDURE ACR_ACC_IMP_COMPARE_RPT_PK (
  aRefCursor              in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PARAMETER_T4            in     varchar2
, PARAMETER_T5            in     varchar2
, PARAMETER_T6            in     varchar2
, PARAMETER_T8            in     varchar2
, PARAMETER_T9            in     varchar2
, PARAMETER_T10           in     varchar2
, PARAMETER_T11           in     varchar2
, PARAMETER_T12           in     varchar2
, PARAMETER_T14           in     varchar2
, PARAMETER_T16           in     varchar2
, PARAMETER_T18           in     varchar2
, PARAMETER_T19           in     varchar2
, PARAMETER_T20           in     varchar2
, aACC_NUMBER_From        in     varchar2
, aACC_NUMBER_To          in     varchar2
, aACS_FINANCIAL_YEAR_ID  in     varchar2
, PROCUSER_LANID          in     pcs.pc_lang.lanid%type
)

is
/**
* Procedure used for report ACR_ACC_IMPUTATION_COMPARE.RPT
*/

VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;
PARAM5  VARCHAR2(10);
PARAM6  VARCHAR2(10);


begin

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);
VPC_LANG_ID:= pcs.PC_I_LIB_SESSION.GetUserLangId;


if (aACC_NUMBER_From is not null) and (Length(Trim(aACC_NUMBER_From)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER1    := aACC_NUMBER_From;
  else
    ACR_FUNCTIONS.ACC_NUMBER1    := '';
  end if;
  if (aACC_NUMBER_To is not null) and (Length(Trim(aACC_NUMBER_To)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER2    := aACC_NUMBER_To;
  end if;
  if (aACS_FINANCIAL_YEAR_ID is not null) and (Length(Trim(aACS_FINANCIAL_YEAR_ID)) > 0) then
    ACR_FUNCTIONS.FIN_YEAR_ID    := aACS_FINANCIAL_YEAR_ID;
  end if;
  if ACS_FUNCTION.GetFirstDivision is not null then
    ACR_FUNCTIONS.EXIST_DIVISION := 1;
  else
    ACR_FUNCTIONS.EXIST_DIVISION := 0;
  end if;

IF LENGTH(PARAMETER_T5) = 1 THEN PARAM5:= '0' || PARAMETER_T5;
 ELSE PARAM5 := PARAMETER_T5;
 END IF ;


 IF LENGTH(PARAMETER_T6) = 1 THEN PARAM6:= '0' || PARAMETER_T6;
 ELSE PARAM6 := PARAMETER_T6;
 END IF ;



open aRefCursor for
SELECT
V_ACC.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
V_ACC.ACC_NUMBER ACC_NUMBER,
V_ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
V_ACC.DES_DESCRIPTION_SUMMARY DES_DESCRIPTION_SUMMARY,
V_ACC.DES_DESCRIPTION_LARGE DES_DESCRIPTION_LARGE,
ACS_FUNCTION.isFinAccountInME(V_ACC.ACS_FINANCIAL_ACCOUNT_ID) isFinAccountInME,
V_IMP.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
V_IMP.ACT_DOCUMENT_ID V_ACT_DOCUMENT_ID,
V_IMP.ACS_FINANCIAL_ACCOUNT_ID V_ACS_FINANCIAL_ACCOUNT_ID,
V_IMP.IMF_TYPE IMF_TYPE,
V_IMP.IMF_DESCRIPTION IMF_DESCRIPTION,
V_IMP.IMF_AMOUNT_LC_D IMF_AMOUNT_LC_D,
V_IMP.IMF_AMOUNT_LC_C IMF_AMOUNT_LC_C,
V_IMP.IMF_EXCHANGE_RATE IMF_EXCHANGE_RATE,
V_IMP.IMF_AMOUNT_FC_D IMF_AMOUNT_FC_D,
V_IMP.IMF_AMOUNT_FC_C IMF_AMOUNT_FC_C,
V_IMP.IMF_VALUE_DATE IMF_VALUE_DATE,
V_IMP.ACS_TAX_CODE_ID ACS_TAX_CODE_ID,
V_IMP.IMF_TRANSACTION_DATE IMF_TRANSACTION_DATE,
V_IMP.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACS_AUXILIARY_ACCOUNT_ID ACS_AUXILIARY_ACCOUNT_ID,
DES_AUX.DES_DESCRIPTION_SUMMARY AUX_DESCRIPTION_SUMMARY,
V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.DOC_DATE_DELIVERY DOC_DATE_DELIVERY,
V_IMP.ACS_DIVISION_ACCOUNT_ID ACS_DIVISION_ACCOUNT_ID,
V_IMP.DIV_NUMBER DIV_NUMBER,
DES_DIV.DES_DESCRIPTION_SUMMARY DIV_DES_DESCRIPTION_SUMMARY,
V_IMP.C_ETAT_JOURNAL C_ETAT_JOURNAL,
V_IMP.C_TYPE_CUMUL C_TYPE_CUMUL,
V_IMP.IMF_COMPARE_DATE IMF_COMPARE_DATE,
V_IMP.IMF_COMPARE_TEXT IMF_COMPARE_TEXT,
V_IMP.IMF_COMPARE_USE_INI IMF_COMPARE_USE_INI,
CAT.C_TYPE_CATALOGUE C_TYPE_CATALOGUE,
CAT.CAT_DESCRIPTION CAT_DESCRIPTION,
AUX.ACC_NUMBER AUX_ACC_NUMBER,
FIN.ACC_NUMBER FIN_ACC_NUMBER,
VAT.ACS_ACCOUNT_ID VAT_ACS_ACCOUNT_ID,
VAT.ACC_NUMBER VAT_ACC_NUMBER,
FUR.PC_CURR_ID FUR_PC_CURR_ID,
FUR_LC.PC_CURR_ID FUR_PC_CURR_ID_LC,
TDO.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
TDO.DOC_NUMBER DOC_NUMBER,
JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
JOU.JOU_NUMBER JOU_NUMBER,
CUR.PC_CURR_ID CUR_PC_CURR_ID,
CUR_LC.PC_CURR_ID CUR_PC_CURR_ID_LC,
CUR.CURRENCY CUR_CURRENCY,
CUR_LC.CURRENCY CUR_CURRENCY_LC,
LAN.LANID LANID,
ACR_FUNCTIONS.CompareReportAmount(V_ACC.ACS_FINANCIAL_ACCOUNT_ID,V_IMP.ACS_DIVISION_ACCOUNT_ID,FYR.ACS_FINANCIAL_YEAR_ID,0) Compare_amount
FROM
V_ACS_FINANCIAL_ACCOUNT V_ACC,
V_ACT_ACC_IMP_REPORT V_IMP,
(SELECT
 ACS_ACCOUNT_ID,
 DES_DESCRIPTION_SUMMARY
 FROM
 ACS_DESCRIPTION
 WHERE
 PC_LANG_ID = VPC_LANG_ID) DES_DIV,
(SELECT
 ACS_ACCOUNT_ID,
 DES_DESCRIPTION_SUMMARY
 FROM
 ACS_DESCRIPTION
 WHERE
 PC_LANG_ID = VPC_LANG_ID) DES_AUX,
ACS_PERIOD PRD,
ACS_FINANCIAL_YEAR FYR,
ACT_DOCUMENT TDO,
ACJ_CATALOGUE_DOCUMENT CAT,
ACT_JOURNAL JOU,
ACS_ACCOUNT AUX,
ACS_ACCOUNT FIN,
ACS_ACCOUNT VAT,
ACS_FINANCIAL_CURRENCY FUR,
ACS_FINANCIAL_CURRENCY FUR_LC,
ACT_FINANCIAL_IMPUTATION IMP,
PCS.PC_CURR CUR,
PCS.PC_CURR CUR_LC,
PCS.PC_LANG LAN,
THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_T14) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST
WHERE
 V_ACC.ACS_FINANCIAL_ACCOUNT_ID = V_IMP.ACS_FINANCIAL_ACCOUNT_ID
AND V_IMP.ACS_PERIOD_ID = PRD.ACS_PERIOD_ID(+)
AND PRD.ACS_FINANCIAL_YEAR_ID = FYR.ACS_FINANCIAL_YEAR_ID(+)
AND V_IMP.ACS_DIVISION_ACCOUNT_ID = DES_DIV.ACS_ACCOUNT_ID(+)
--AND DES_DIV.PC_LANG_ID(+) = VPC_LANG_ID
AND V_IMP.ACT_DOCUMENT_ID = TDO.ACT_DOCUMENT_ID(+)
AND TDO.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND TDO.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID(+)
AND V_IMP.ACS_TAX_CODE_ID = VAT.ACS_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = FUR.ACS_FINANCIAL_CURRENCY_ID(+)
AND FUR.PC_CURR_ID = CUR.PC_CURR_ID(+)
AND V_IMP.ACS_AUXILIARY_ACCOUNT_ID = AUX.ACS_ACCOUNT_ID(+)
AND AUX.ACS_ACCOUNT_ID = DES_AUX.ACS_ACCOUNT_ID(+)
--AND DES_AUX.PC_LANG_ID(+) = VPC_LANG_ID
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = FUR_LC.ACS_FINANCIAL_CURRENCY_ID(+)
AND FUR_LC.PC_CURR_ID = CUR_LC.PC_CURR_ID(+)
AND V_IMP.ACT_FINANCIAL_IMPUTATION_ID = IMP.ACT_FINANCIAL_IMPUTATION_ID(+)
AND IMP.ACS_FINANCIAL_ACCOUNT_ID = FIN.ACS_ACCOUNT_ID(+)
AND V_ACC.PC_LANG_ID(+) = VPC_LANG_ID
AND LAN.PC_LANG_ID(+) = VPC_LANG_ID
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(PARAMETER_T4|| PARAM5 ||PARAM6,'yyyyMMdd')
AND DECODE(V_IMP.C_ETAT_JOURNAL,NULL,1,'BRO',DECODE(PARAMETER_T10,'1',1,0),'PROV',DECODE(PARAMETER_T11,'1',1,0),'DEF',DECODE(PARAMETER_T12,'1',1,0),0)=1
AND (PARAMETER_T14 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND DECODE(PARAMETER_T16,'0',1,'1',DECODE(V_IMP.IMF_COMPARE_DATE,NULL,0,1),'2',DECODE(CAT.CAT_DESCRIPTION,'7',0,DECODE(V_IMP.IMF_COMPARE_DATE,NULL,1,0)),0)=1
AND DECODE(PARAMETER_T8,1,DECODE(V_IMP.IMF_TYPE,'VAT',0,DECODE(V_IMP.ACS_TAX_CODE_ID,NULL,1,0)),1)=1
AND DECODE(V_IMP.C_TYPE_CUMUL,'INT',DECODE(PARAMETER_T9,'1',1,0),'EXT',DECODE(PARAMETER_T18,'1',1,0),'PRE',DECODE(PARAMETER_T19,'1',1,0),'ENG',DECODE(PARAMETER_T20,'1',1,0),0)=1
AND DECODE(PARAMETER_T16,'0',1,DECODE(V_IMP.ACT_JOURNAL_ID,'NULL',0,DECODE(JOU.C_TYPE_JOURNAL,'OPB',0,1)))=1
UNION ALL
SELECT
V_ACC.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
V_ACC.ACC_NUMBER ACC_NUMBER,
V_ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
V_ACC.DES_DESCRIPTION_SUMMARY DES_DESCRIPTION_SUMMARY,
V_ACC.DES_DESCRIPTION_LARGE DES_DESCRIPTION_LARGE,
ACS_FUNCTION.isFinAccountInME(V_ACC.ACS_FINANCIAL_ACCOUNT_ID) isFinAccountInME,
NULL ACT_FINANCIAL_IMPUTATION_ID,
NULL V_ACT_DOCUMENT_ID,
NULL V_ACS_FINANCIAL_ACCOUNT_ID,
NULL IMF_TYPE,
NULL IMF_DESCRIPTION,
NULL IMF_AMOUNT_LC_D,
NULL IMF_AMOUNT_LC_C,
NULL IMF_EXCHANGE_RATE,
NULL IMF_AMOUNT_FC_D,
NULL IMF_AMOUNT_FC_C,
NULL IMF_VALUE_DATE,
NULL ACS_TAX_CODE_ID,
NULL IMF_TRANSACTION_DATE,
NULL ACS_FINANCIAL_CURRENCY_ID,
NULL ACS_AUXILIARY_ACCOUNT_ID,
NULL AUX_DESCRIPTION_SUMMARY,
NULL ACS_ACS_FINANCIAL_CURRENCY_ID,
NULL DOC_DATE_DELIVERY,
NULL ACS_DIVISION_ACCOUNT_ID,
NULL DIV_NUMBER,
NULL DIV_DES_DESCRIPTION_SUMMARY,
NULL C_ETAT_JOURNAL,
NULL C_TYPE_CUMUL,
NULL IMF_COMPARE_DATE,
NULL IMF_COMPARE_TEXT,
NULL IMF_COMPARE_USE_INI,
NULL C_TYPE_CATALOGUE,
NULL CAT_DESCRIPTION,
NULL AUX_ACC_NUMBER,
NULL FIN_ACC_NUMBER,
NULL VAT_ACS_ACCOUNT_ID,
NULL VAT_ACC_NUMBER,
NULL FUR_PC_CURR_ID,
NULL FUR_PC_CURR_ID_LC,
NULL ACT_DOCUMENT_ID,
NULL DOC_NUMBER,
NULL JOU_DESCRIPTION,
NULL C_TYPE_JOURNAL,
NULL JOU_NUMBER,
NULL CUR_PC_CURR_ID,
NULL CUR_PC_CURR_ID_LC,
NULL CUR_CURRENCY,
NULL CUR_CURRENCY_LC,
NULL LANID,
NULL Compare_amount
FROM
V_ACS_FINANCIAL_ACCOUNT V_ACC,
V_ACT_ACC_IMP_REPORT V_IMP
WHERE
V_ACC.ACS_FINANCIAL_ACCOUNT_ID <> V_IMP.ACS_FINANCIAL_ACCOUNT_ID
AND V_ACC.ACC_NUMBER >= ACR_FUNCTIONS.GetAccNumber(1)
AND V_ACC.ACC_NUMBER <= ACR_FUNCTIONS.GetAccNumber(0)
AND V_ACC.PC_LANG_ID = VPC_LANG_ID
;
end ACR_ACC_IMP_COMPARE_RPT_PK;


PROCEDURE ACR_ACC_IMP_LET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, aACC_NUMBER_From           in     varchar2
, aACC_NUMBER_To             in     varchar2
, aACS_FINANCIAL_YEAR_ID     in     varchar2
, PARAMETER_4                in     varchar2
, PARAMETER_5                in     varchar2
, PARAMETER_6                in     varchar2
, PARAMETER_8                in     varchar2
, PARAMETER_9                in     varchar2
, PARAMETER_10               in     varchar2
, PARAMETER_11               in     varchar2
, PARAMETER_12               in     varchar2
, PARAMETER_14               in     varchar2
, PARAMETER_16               in     varchar2
, PARAMETER_18               in     varchar2
, PARAMETER_19               in     varchar2
, PARAMETER_20               in     varchar2
, PROCUSER_LANID             in     pcs.pc_lang.lanid%type
)
is
/**
*DESCRIPTION
USED FOR REPORT ACR_REC_IMPUTATION_DET (????) ACR_ACC_IMPUTATION_LETTERING
*/

TMP NUMBER;
VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;
PARAM5  VARCHAR2(10);
PARAM6  VARCHAR2(10);

BEGIN

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);
VPC_LANG_ID:= pcs.PC_I_LIB_SESSION.GetUserLangId;

  if (aACC_NUMBER_From is not null) and (Length(Trim(aACC_NUMBER_From)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER1    := aACC_NUMBER_From;
  else
    ACR_FUNCTIONS.ACC_NUMBER1    := '';
  end if;
  if (aACC_NUMBER_To is not null) and (Length(Trim(aACC_NUMBER_To)) > 0) then
    ACR_FUNCTIONS.ACC_NUMBER2    := aACC_NUMBER_To;
  end if;
  if (aACS_FINANCIAL_YEAR_ID is not null) and (Length(Trim(aACS_FINANCIAL_YEAR_ID)) > 0) then
    ACR_FUNCTIONS.FIN_YEAR_ID    := aACS_FINANCIAL_YEAR_ID;
  end if;
  if ACS_FUNCTION.GetFirstDivision is not null then
    ACR_FUNCTIONS.EXIST_DIVISION := 1;
  else
    ACR_FUNCTIONS.EXIST_DIVISION := 0;
  end if;

 IF LENGTH(PARAMETER_5) = 1 THEN PARAM5:= '0' || PARAMETER_5;
 ELSE PARAM5 := PARAMETER_5;
 END IF ;


 IF LENGTH(PARAMETER_6) = 1 THEN PARAM6:= '0' || PARAMETER_6;
 ELSE PARAM6 := PARAMETER_6;
 END IF ;


open aRefCursor for
SELECT
V_ACC.ACC_NUMBER ACC_NUMBER,
V_ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
V_ACC.DES_DESCRIPTION_SUMMARY DES_DESCRIPTION_SUMMARY,
V_ACC.DES_DESCRIPTION_LARGE DES_DESCRIPTION_LARGE,
V_IMP.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
V_IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
V_IMP.IMF_TYPE IMF_TYPE,
V_IMP.IMF_DESCRIPTION IMF_DESCRIPTION,
V_IMP.IMF_AMOUNT_LC_D IMF_AMOUNT_LC_D,
V_IMP.IMF_AMOUNT_LC_C IMF_AMOUNT_LC_C,
V_IMP.IMF_VALUE_DATE IMF_VALUE_DATE,
V_IMP.ACS_TAX_CODE_ID ACS_TAX_CODE_ID,
V_IMP.IMF_TRANSACTION_DATE IMF_TRANSACTION_DATE,
V_IMP.ACS_AUXILIARY_ACCOUNT_ID ACS_AUXILIARY_ACCOUNT_ID,
V_IMP.DOC_DATE_DELIVERY DOC_DATE_DELIVERY,
V_IMP.ACS_DIVISION_ACCOUNT_ID ACS_DIVISION_ACCOUNT_ID,
V_IMP.DIV_NUMBER DIV_NUMBER,
V_IMP.C_ETAT_JOURNAL C_ETAT_JOURNAL,
V_IMP.C_TYPE_CUMUL C_TYPE_CUMUL,
CAT.C_TYPE_CATALOGUE C_TYPE_CATALOGUE,
AUX.ACC_NUMBER ACC_NUMBER_AUX,
FIN.ACC_NUMBER ACC_NUMBER_FIN,
VAT.ACS_ACCOUNT_ID VAT_ACS_ACCOUNT_ID,
VAT.ACC_NUMBER ACC_NUMBER_VAT,
FYR.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
ATD.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
ATD.DOC_NUMBER DOC_NUMBER,
JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
JOU.JOU_NUMBER JOU_NUMBER,
CUR.CURRENCY CURRENCY,
CUR_LC.CURRENCY CURRENCY_LC,
LAN.LANID LANID,
DES_AUX.DES_DESCRIPTION_SUMMARY AUX_DES_DESCRIPTION_SUMMARY,
DES_DIV.DES_DESCRIPTION_SUMMARY DIV_DES_DESCRIPTION_SUMMARY,
Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'D',NULL),2) LET_AMNT_LD,
Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'C',NULL),2) LET_AMNT_LC
FROM
V_ACS_FINANCIAL_ACCOUNT V_ACC,
V_ACT_ACC_IMP_REPORT V_IMP,
PCS.PC_LANG LAN,
ACS_PERIOD PRD,
ACS_FINANCIAL_YEAR FYR,
ACT_DOCUMENT ATD,
ACJ_CATALOGUE_DOCUMENT CAT,
ACT_JOURNAL JOU,
ACS_ACCOUNT VAT,
ACS_ACCOUNT AUX,
ACS_ACCOUNT FIN,
ACS_FINANCIAL_CURRENCY FUR,
PCS.PC_CURR CUR,
ACS_FINANCIAL_CURRENCY FUR_LC,
PCS.PC_CURR CUR_LC,
ACT_FINANCIAL_IMPUTATION IMP,
ACS_DESCRIPTION DES_AUX,
ACS_DESCRIPTION DES_DIV,
THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_14) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST
WHERE
V_ACC.ACS_FINANCIAL_ACCOUNT_ID = V_IMP.ACS_FINANCIAL_ACCOUNT_ID
AND V_ACC.PC_LANG_ID (+) = VPC_LANG_ID
AND V_IMP.ACS_PERIOD_ID = PRD.ACS_PERIOD_ID(+)
AND PRD.ACS_FINANCIAL_YEAR_ID = FYR.ACS_FINANCIAL_YEAR_ID(+)
AND V_IMP.ACT_DOCUMENT_ID = ATD.ACT_DOCUMENT_ID(+)
AND ATD.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND ATD.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID(+)
AND V_IMP.ACS_TAX_CODE_ID = VAT.ACS_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = FUR.ACS_FINANCIAL_CURRENCY_ID(+)
AND FUR.PC_CURR_ID = CUR.PC_CURR_ID(+)
AND V_IMP.ACS_AUXILIARY_ACCOUNT_ID = AUX.ACS_ACCOUNT_ID(+)
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = FUR_LC.ACS_FINANCIAL_CURRENCY_ID(+)
AND FUR_LC.PC_CURR_ID = CUR_LC.PC_CURR_ID(+)
AND V_IMP.ACT_FINANCIAL_IMPUTATION_ID = IMP.ACT_FINANCIAL_IMPUTATION_ID(+)
AND IMP.ACS_FINANCIAL_ACCOUNT_ID = FIN.ACS_ACCOUNT_ID(+)
AND LAN.PC_LANG_ID(+) = VPC_LANG_ID
AND AUX.ACS_ACCOUNT_ID = DES_AUX.ACS_ACCOUNT_ID(+)
AND DES_AUX.PC_LANG_ID(+) = VPC_LANG_ID
AND V_IMP.ACS_DIVISION_ACCOUNT_ID = DES_DIV.ACS_ACCOUNT_ID(+)
AND DES_DIV.PC_LANG_ID(+) = VPC_LANG_ID
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(PARAMETER_4|| PARAM5 ||PARAM6,'yyyyMMdd')
AND (( PARAMETER_10 = '1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_11 = '1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
    OR (PARAMETER_12 = '1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND (PARAMETER_14 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND (PARAMETER_16 = '0'
   OR (PARAMETER_16 = '1' AND Round(V_IMP.IMF_AMOUNT_LC_D,2)=Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'D',NULL),2)
                           AND Round(V_IMP.IMF_AMOUNT_LC_C,2)=Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'C',NULL),2)
                           AND (V_IMP.IMF_AMOUNT_LC_D<>0 OR V_IMP.IMF_AMOUNT_LC_C<> 0))
   OR (PARAMETER_16 = '1' AND (Round(V_IMP.IMF_AMOUNT_LC_D,2)<>Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'D',NULL),2)
                               OR Round(V_IMP.IMF_AMOUNT_LC_C,2)<>Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'C',NULL),2)
                               OR (V_IMP.IMF_AMOUNT_LC_D = 0 AND V_IMP.IMF_AMOUNT_LC_C = 0))
                           AND ((Round(V_IMP.IMF_AMOUNT_LC_D,2)<>0  AND  Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'D',NULL),2)<>0)
                            OR (Round(V_IMP.IMF_AMOUNT_LC_C,2)<>0  AND  Round(ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'C',NULL),2)<>0)
                            ))
   OR (PARAMETER_16 = '2' AND CAT.C_TYPE_CATALOGUE IS NOT NULL
                           AND CAT.C_TYPE_CATALOGUE <> '7'
                           AND (V_IMP.IMF_AMOUNT_LC_D <> ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'D',NULL)
                           OR V_IMP.IMF_AMOUNT_LC_C <> ACR_FUNCTIONS.TOTAL_LETTERING_AMOUNT_IMPUT(V_IMP.ACT_FINANCIAL_IMPUTATION_ID,'C',NULL))))
                           --OR (V_IMP.IMF_AMOUNT_LC_D<>0 AND V_IMP.IMF_AMOUNT_LC_C<> 0)))
AND ((PARAMETER_8 = '1' AND V_IMP.IMF_TYPE <>'VAT' AND  V_IMP.ACS_TAX_CODE_ID IS NULL )
     OR (PARAMETER_8 <> '1' AND V_IMP.IMF_TYPE IS NOT NULL))
AND ((PARAMETER_18 ='1' AND V_IMP.C_TYPE_CUMUL = 'EXT')
    OR (PARAMETER_9 ='1' AND  V_IMP.C_TYPE_CUMUL ='INT')
    OR (PARAMETER_19 ='1' AND V_IMP.C_TYPE_CUMUL ='PRE')
    OR (PARAMETER_20='1' AND V_IMP.C_TYPE_CUMUL ='ENG'))
UNION ALL
SELECT DISTINCT
V_ACC.ACC_NUMBER ACC_NUMBER,
V_ACC.ACC_DETAIL_PRINTING ACC_DETAIL_PRINTING,
V_ACC.DES_DESCRIPTION_SUMMARY DES_DESCRIPTION_SUMMARY,
V_ACC.DES_DESCRIPTION_LARGE DES_DESCRIPTION_LARGE,
NULL ACT_FINANCIAL_IMPUTATION_ID,
NULL ACS_FINANCIAL_ACCOUNT_ID,
NULL IMF_TYPE,
NULL IMF_DESCRIPTION,
NULL IMF_AMOUNT_LC_D,
NULL IMF_AMOUNT_LC_C,
NULL IMF_VALUE_DATE,
NULL ACS_TAX_CODE_ID,
NULL IMF_TRANSACTION_DATE,
NULL ACS_AUXILIARY_ACCOUNT_ID,
NULL DOC_DATE_DELIVERY,
NULL ACS_DIVISION_ACCOUNT_ID,
NULL DIV_NUMBER,
NULL C_ETAT_JOURNAL,
NULL C_TYPE_CUMUL,
NULL C_TYPE_CATALOGUE,
NULL ACC_NUMBER_AUX,
NULL ACC_NUMBER_FIN,
NULL VAT_ACS_ACCOUNT_ID,
NULL ACC_NUMBER_VAT,
NULL ACS_FINANCIAL_YEAR_ID,
NULL ACT_DOCUMENT_ID,
NULL DOC_NUMBER,
NULL JOU_DESCRIPTION,
NULL JOU_NUMBER,
NULL CURRENCY,
NULL CURRENCY_LC,
NULL LANID,
NULL AUX_DES_DESCRIPTION_SUMMARY,
NULL DIV_DES_DESCRIPTION_SUMMARY,
NULL LET_AMNT_LD,
NULL LET_AMNT_LC
FROM
V_ACS_FINANCIAL_ACCOUNT V_ACC,
V_ACT_ACC_IMP_REPORT V_IMP
WHERE
V_ACC.ACS_FINANCIAL_ACCOUNT_ID <> V_IMP.ACS_FINANCIAL_ACCOUNT_ID
AND V_ACC.ACC_NUMBER >= ACR_FUNCTIONS.GetAccNumber(1)
AND V_ACC.ACC_NUMBER <= ACR_FUNCTIONS.GetAccNumber(0)
AND V_ACC.PC_LANG_ID = VPC_LANG_ID;
end ACR_ACC_IMP_LET_RPT_PK
;
PROCEDURE ACR_RCO_IMPUTATION_DET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PROCPARAM_0 in     number
, PROCPARAM_1 in     varchar2
, PROCPARAM_2 in     varchar2
, PROCUSER_LANID in  pcs.pc_lang.lanid%type
)

is
/**
* Proc¨¦dure stock¨¦e utilis¨¦e pour les rapports ACR_RCO_IMPUTATION_DET et ACR_RCO_IMPUTATION_DET_FC
*(Mouvements Dossiers sans et avec ME)
*/

VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;

BEGIN

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);
VPC_LANG_ID:= pcs.PC_I_LIB_SESSION.GetUserLangId;

open aRefCursor for
  SELECT
    'REEL' INFO,
    MGM.ACT_MGM_IMPUTATION_ID ACT_MGM_IMPUTATION_ID,
    MGM.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    MGM.IMM_TRANSACTION_DATE IMM_TRANSACTION_DATE,
    MGM.IMM_VALUE_DATE IMM_VALUE_DATE,
    MGM.IMM_DESCRIPTION IMM_DESCRIPTION,
    MGM.DOC_RECORD_ID,
    RCO.RCO_TITLE,
    RCO.RCO_DESCRIPTION,
    MGM.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    (SELECT AC1.ACC_NUMBER
     FROM   ACS_ACCOUNT AC1
     WHERE  MGM.ACS_CPN_ACCOUNT_ID = AC1.ACS_ACCOUNT_ID) CPN_NUMBER,
    MGM.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    (SELECT AC2.ACC_NUMBER
     FROM   ACS_ACCOUNT AC2
     WHERE  MGM.ACS_CDA_ACCOUNT_ID = AC2.ACS_ACCOUNT_ID) CDA_NUMBER,
    MGM.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    (SELECT AC3.ACC_NUMBER
     FROM   ACS_ACCOUNT AC3
     WHERE  MGM.ACS_PF_ACCOUNT_ID = AC3.ACS_ACCOUNT_ID) PF_NUMBER,
    DIS.ACS_PJ_ACCOUNT_ID,
    (SELECT AC4.ACC_NUMBER
     FROM   ACS_ACCOUNT AC4
     WHERE  DIS.ACS_PJ_ACCOUNT_ID = AC4.ACS_ACCOUNT_ID) PJ_NUMBER,
    MGM.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
     FROM   PCS.PC_CURR             CUB,
            ACS_FINANCIAL_CURRENCY  CFB
     WHERE  CFB.ACS_FINANCIAL_CURRENCY_ID = MGM.ACS_ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    MGM.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUE.CURRENCY
     FROM   PCS.PC_CURR             CUE,
            ACS_FINANCIAL_CURRENCY  CFE
     WHERE  CFE.ACS_FINANCIAL_CURRENCY_ID = MGM.ACS_FINANCIAL_CURRENCY_ID AND
            CUE.PC_CURR_ID                = CFE.PC_CURR_ID) CURRENCY_ME,
    MGM.IMM_AMOUNT_LC_D IMM_AMOUNT_LC_D,
    MGM.IMM_AMOUNT_LC_C IMM_AMOUNT_LC_C,
    MGM.IMM_AMOUNT_FC_D IMM_AMOUNT_FC_D,
    MGM.IMM_AMOUNT_FC_C IMM_AMOUNT_FC_C,
    MGM.ACS_PERIOD_ID ACS_PERIOD_ID,
    IMF.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    (SELECT AC5.ACC_NUMBER
     FROM   ACS_ACCOUNT AC5
     WHERE  IMF.ACS_FINANCIAL_ACCOUNT_ID = AC5.ACS_ACCOUNT_ID) FIN_NUMBER,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMF.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMF.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    (SELECT DES.DES_DESCRIPTION_SUMMARY
     FROM   ACS_DESCRIPTION DES
     WHERE  DES.ACS_ACCOUNT_ID  = ACT_FUNCTIONS.AuxAccountFromImputation(IMF.ACT_FINANCIAL_IMPUTATION_ID) AND
            DES.PC_LANG_ID      = VPC_LANG_ID) AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
     FROM   ACT_ETAT_JOURNAL ETA
     WHERE  ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
            ETA.C_SUB_SET      = 'CPN') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
     FROM   ACJ_SUB_SET_CAT SCA
     WHERE  SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
            SCA.C_SUB_SET                 = 'CPN') C_TYPE_CUMUL,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
  FROM
    ACT_FINANCIAL_IMPUTATION  IMF,
    ACT_JOURNAL               JOU,
    ACT_DOCUMENT              DOC,
    ACS_PERIOD                PER,
    ACS_FINANCIAL_YEAR        FYE,
    ACT_MGM_DISTRIBUTION      DIS,
    ACT_MGM_IMPUTATION        MGM,
    DOC_RECORD                RCO
  WHERE
    RCO.RCO_TITLE                   >= PROCPARAM_1 AND
    RCO.RCO_TITLE                   <= PROCPARAM_2 AND
    MGM.DOC_RECORD_ID               = RCO.DOC_RECORD_ID AND
    MGM.ACT_MGM_IMPUTATION_ID       = DIS.ACT_MGM_IMPUTATION_ID (+) AND
    FYE.FYE_NO_EXERCICE             = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID       = PER.ACS_FINANCIAL_YEAR_ID AND
    MGM.ACS_PERIOD_ID               = PER.ACS_PERIOD_ID AND
    MGM.ACT_DOCUMENT_ID             = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_ACT_JOURNAL_ID          = JOU.ACT_JOURNAL_ID AND
    MGM.ACT_FINANCIAL_IMPUTATION_ID = IMF.ACT_FINANCIAL_IMPUTATION_ID (+)
UNION ALL
  SELECT
    'REPORT' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    FYE.FYE_START_DATE IMM_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMM_VALUE_DATE,
    'Report' IMM_DESCRIPTION,
    TOT.DOC_RECORD_ID,
    RCO.RCO_TITLE,
    RCO.RCO_DESCRIPTION,
    TOT.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    (SELECT AC1.ACC_NUMBER
     FROM   ACS_ACCOUNT AC1
     WHERE  TOT.ACS_CPN_ACCOUNT_ID = AC1.ACS_ACCOUNT_ID) CPN_NUMBER,
    TOT.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    (SELECT AC2.ACC_NUMBER
     FROM   ACS_ACCOUNT AC2
     WHERE  TOT.ACS_CDA_ACCOUNT_ID = AC2.ACS_ACCOUNT_ID) CDA_NUMBER,
    TOT.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    (SELECT AC3.ACC_NUMBER
     FROM   ACS_ACCOUNT AC3
     WHERE  TOT.ACS_PF_ACCOUNT_ID = AC3.ACS_ACCOUNT_ID) PF_NUMBER,
    TOT.ACS_PJ_ACCOUNT_ID,
    (SELECT AC4.ACC_NUMBER
     FROM   ACS_ACCOUNT AC4
     WHERE  TOT.ACS_PJ_ACCOUNT_ID = AC4.ACS_ACCOUNT_ID) PJ_NUMBER,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
     FROM   PCS.PC_CURR             CUB,
            ACS_FINANCIAL_CURRENCY  CFB
     WHERE  CFB.ACS_FINANCIAL_CURRENCY_ID = TOT.ACS_ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUE.CURRENCY
     FROM   PCS.PC_CURR             CUE,
            ACS_FINANCIAL_CURRENCY  CFE
     WHERE  CFE.ACS_FINANCIAL_CURRENCY_ID = TOT.ACS_FINANCIAL_CURRENCY_ID AND
            CUE.PC_CURR_ID                = CFE.PC_CURR_ID) CURRENCY_ME,
    TOT.MTO_DEBIT_LC IMM_AMOUNT_LC_D,
    TOT.MTO_CREDIT_LC IMM_AMOUNT_LC_C,
    TOT.MTO_DEBIT_FC IMM_AMOUNT_FC_D,
    TOT.MTO_CREDIT_FC IMM_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    (SELECT AC5.ACC_NUMBER
     FROM   ACS_ACCOUNT AC5
     WHERE  TOT.ACS_FINANCIAL_ACCOUNT_ID = AC5.ACS_ACCOUNT_ID ) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL C_TYPE_CUMUL,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
  FROM
    ACS_FINANCIAL_YEAR    FYE,
    ACS_PERIOD            PER,
    ACT_MGM_TOT_BY_PERIOD TOT,
    DOC_RECORD            RCO
  WHERE
    RCO.RCO_TITLE               >= PROCPARAM_1 AND
    RCO.RCO_TITLE               <= PROCPARAM_2 AND
    TOT.DOC_RECORD_ID           = RCO.DOC_RECORD_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID           = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD           = '1'
UNION ALL
  SELECT
    'BUDGET' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    GLO.DOC_RECORD_ID,
    RCO.RCO_TITLE,
    RCO.RCO_DESCRIPTION,
    GLO.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    (SELECT AC1.ACC_NUMBER
     FROM   ACS_ACCOUNT AC1
     WHERE  GLO.ACS_CPN_ACCOUNT_ID = AC1.ACS_ACCOUNT_ID) CPN_NUMBER,
    GLO.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    (SELECT AC2.ACC_NUMBER
     FROM   ACS_ACCOUNT AC2
     WHERE  GLO.ACS_CDA_ACCOUNT_ID = AC2.ACS_ACCOUNT_ID) CDA_NUMBER,
    GLO.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    (SELECT AC3.ACC_NUMBER
     FROM   ACS_ACCOUNT AC3
     WHERE  GLO.ACS_PF_ACCOUNT_ID = AC3.ACS_ACCOUNT_ID) PF_NUMBER,
    GLO.ACS_PJ_ACCOUNT_ID,
    (SELECT AC4.ACC_NUMBER
     FROM   ACS_ACCOUNT AC4
     WHERE  GLO.ACS_PJ_ACCOUNT_ID = AC4.ACS_ACCOUNT_ID) PJ_NUMBER,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    (SELECT CUB.CURRENCY
     FROM   PCS.PC_CURR             CUB,
            ACS_FINANCIAL_CURRENCY  CFB
     WHERE  CFB.ACS_FINANCIAL_CURRENCY_ID = GLO.ACS_FINANCIAL_CURRENCY_ID AND
            CUB.PC_CURR_ID                = CFB.PC_CURR_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    (SELECT AC5.ACC_NUMBER
     FROM   ACS_ACCOUNT AC5
     WHERE  GLO.ACS_FINANCIAL_ACCOUNT_ID = AC5.ACS_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
  FROM
    ACS_FINANCIAL_YEAR  FYE,
    ACS_PERIOD          PER,
    ACB_PERIOD_AMOUNT   PERB,
    ACB_GLOBAL_BUDGET   GLO,
    ACB_BUDGET_VERSION  VER,
    ACB_BUDGET          BUD,
    DOC_RECORD          RCO
  WHERE
    RCO.RCO_TITLE                       >= PROCPARAM_1 AND
    RCO.RCO_TITLE                       <= PROCPARAM_2 AND
    GLO.DOC_RECORD_ID                   = RCO.DOC_RECORD_ID AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID                   = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT                     = 1 AND
    VER.ACB_BUDGET_VERSION_ID           = GLO.ACB_BUDGET_VERSION_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID            = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID                  = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID           = FYE.ACS_FINANCIAL_YEAR_ID
UNION ALL
  SELECT
    'VIDE' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    RCO.DOC_RECORD_ID,
    RCO.RCO_TITLE,
    RCO.RCO_DESCRIPTION,
    0 ACS_CPN_ACCOUNT_ID,
    NULL CPN_NUMBER,
    0 ACS_CDA_ACCOUNT_ID,
    NULL CDA_NUMBER,
    0 ACS_PF_ACCOUNT_ID,
    NULL PF_NUMBER,
    0 ACS_PJ_ACCOUNT_ID,
    NULL PJ_NUMBER,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    0 ACS_FINANCIAL_ACCOUNT_ID,
    NULL FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
  FROM
    DOC_RECORD  RCO
  WHERE
    RCO.RCO_TITLE                       >= PROCPARAM_1 AND
    RCO.RCO_TITLE                       <= PROCPARAM_2 AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  FYE,
                    ACS_PERIOD          PER,
                    ACT_MGM_IMPUTATION  MGM
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        MGM.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        MGM.DOC_RECORD_ID           = RCO.DOC_RECORD_ID);
end ACR_RCO_IMPUTATION_DET_RPT_PK;


PROCEDURE  ACR_CDA_IMPUTATION_DET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PROCPARAM_0 in     number
, PROCPARAM_1 in     varchar2
, PROCPARAM_2 in     varchar2
, PROCUSER_LANID in  pcs.pc_lang.lanid%type
)

is
/**
* Proc¨¦dure stock¨¦e utilis¨¦e pour les rapports ACR_CDA_IMPUTATION_DET et ACR_CDA_IMPUTATION_DET_FC
* (Mouvements CDA sans et avec ME)
*/
begin

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);

open aRefCursor for
SELECT
    'REEL' INFO,
    MGM.ACT_MGM_IMPUTATION_ID ACT_MGM_IMPUTATION_ID,
    MGM.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    MGM.IMM_TRANSACTION_DATE IMM_TRANSACTION_DATE,
    MGM.IMM_VALUE_DATE IMM_VALUE_DATE,
    MGM.IMM_DESCRIPTION IMM_DESCRIPTION,
    MGM.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(MGM.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    MGM.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(MGM.ACS_CDA_ACCOUNT_ID) CDA_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',MGM.ACS_CDA_ACCOUNT_ID) CDA_LARGE_DESCR,
    MGM.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    DIS.ACT_MGM_DISTRIBUTION_ID ACT_MGM_DISTRIBUTION_ID,
    DIS.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(DIS.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    MGM.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    MGM.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    MGM.IMM_AMOUNT_LC_D IMM_AMOUNT_LC_D,
    MGM.IMM_AMOUNT_LC_C IMM_AMOUNT_LC_C,
    MGM.IMM_AMOUNT_FC_D IMM_AMOUNT_FC_D,
    MGM.IMM_AMOUNT_FC_C IMM_AMOUNT_FC_C,
    MGM.ACS_PERIOD_ID ACS_PERIOD_ID,
   	MGM.DIC_IMP_FREE1_ID DIC_IMP_FREE1_ID,
    MGM.DIC_IMP_FREE2_ID DIC_IMP_FREE2_ID,
    MGM.DIC_IMP_FREE3_ID DIC_IMP_FREE3_ID,
    MGM.DIC_IMP_FREE4_ID DIC_IMP_FREE4_ID,
    MGM.DIC_IMP_FREE5_ID DIC_IMP_FREE5_ID,
    IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(IMP.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
     FROM ACT_ETAT_JOURNAL ETA
     WHERE ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
           ETA.C_SUB_SET      = 'CPN') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
     FROM ACJ_SUB_SET_CAT SCA
     WHERE SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
           SCA.C_SUB_SET                 = 'CPN') C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CDA.ACS_CDA_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACT_JOURNAL               JOU,
    ACT_DOCUMENT              DOC,
    ACS_PERIOD                PER,
    ACS_FINANCIAL_YEAR        FYE,
    ACT_FINANCIAL_IMPUTATION  IMP,
    ACT_MGM_DISTRIBUTION      DIS,
    ACT_MGM_IMPUTATION        MGM,
    ACS_ACCOUNT               ACC,
    ACS_CDA_ACCOUNT           CDA
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    CDA.ACS_CDA_ACCOUNT_ID              = ACC.ACS_ACCOUNT_ID AND
    CDA.ACS_CDA_ACCOUNT_ID              = MGM.ACS_CDA_ACCOUNT_ID (+) AND
    MGM.ACT_FINANCIAL_IMPUTATION_ID     = IMP.ACT_FINANCIAL_IMPUTATION_ID (+) AND
    MGM.ACT_MGM_IMPUTATION_ID           = DIS.ACT_MGM_IMPUTATION_ID (+) AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    MGM.ACS_PERIOD_ID                   = PER.ACS_PERIOD_ID AND
    MGM.ACT_DOCUMENT_ID                 = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_ACT_JOURNAL_ID              = JOU.ACT_JOURNAL_ID
UNION ALL
SELECT
    'REPORT' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    FYE.FYE_START_DATE IMM_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMM_VALUE_DATE,
    'Report' IMM_DESCRIPTION,
    TOT.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    TOT.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_CDA_ACCOUNT_ID) CDA_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',TOT.ACS_CDA_ACCOUNT_ID) CDA_LARGE_DESCR,
    TOT.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    TOT.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    TOT.MTO_DEBIT_LC IMM_AMOUNT_LC_D,
    TOT.MTO_CREDIT_LC IMM_AMOUNT_LC_C,
    TOT.MTO_DEBIT_FC IMM_AMOUNT_FC_D,
    TOT.MTO_CREDIT_FC IMM_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CDA.ACS_CDA_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR FYE,
    ACS_PERIOD PER,
    ACS_CDA_ACCOUNT CDA,
    ACS_ACCOUNT ACC,
    ACT_MGM_TOT_BY_PERIOD TOT
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    CDA.ACS_CDA_ACCOUNT_ID              = ACC.ACS_ACCOUNT_ID AND
    CDA.ACS_CDA_ACCOUNT_ID              = TOT.ACS_CDA_ACCOUNT_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID                   = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD                   = '1'
UNION ALL
SELECT
    'BUDGET' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    GLO.ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    GLO.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_CDA_ACCOUNT_ID) CDA_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',GLO.ACS_CDA_ACCOUNT_ID) CDA_LARGE_DESCR,
    GLO.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    GLO.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(GLO.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CDA.ACS_CDA_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR      FYE,
    ACS_PERIOD              PER,
    ACB_PERIOD_AMOUNT       PERB,
    ACB_GLOBAL_BUDGET       GLO,
    ACB_BUDGET_VERSION      VER,
    ACB_BUDGET              BUD,
    ACS_ACCOUNT             ACC,
    ACS_CDA_ACCOUNT         CDA
WHERE
    FYE.FYE_NO_EXERCICE       = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID         = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT           = 1 AND
    VER.ACB_BUDGET_VERSION_ID = GLO.ACB_BUDGET_VERSION_ID AND
    ACC.ACC_NUMBER            >= PROCPARAM_1 AND
    ACC.ACC_NUMBER            <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID        = CDA.ACS_CDA_ACCOUNT_ID AND
    CDA.ACS_CDA_ACCOUNT_ID    = GLO.ACS_CDA_ACCOUNT_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID  = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID        = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID = FYE.ACS_FINANCIAL_YEAR_ID
UNION ALL
SELECT
    'VIDE' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    0 ACS_CPN_ACCOUNT_ID,
    NULL CPN_NUMBER,
    NULL CPN_DESCR,
    0 ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(CDA.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(CDA.ACS_CDA_ACCOUNT_ID) CDA_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',CDA.ACS_CDA_ACCOUNT_ID) CDA_LARGE_DESCR,
    0 ACS_PF_ACCOUNT_ID,
    NULL PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    0 ACS_PJ_ACCOUNT_ID,
    NULL PJ_NUMBER,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    NULL DIC_IMP_FREE1_ID,
    NULL DIC_IMP_FREE2_ID,
    NULL DIC_IMP_FREE3_ID,
    NULL DIC_IMP_FREE4_ID,
    NULL DIC_IMP_FREE5_ID,
    0 ACS_FINANCIAL_ACCOUNT_ID,
    NULL FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CDA.ACS_CDA_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_CDA_ACCOUNT CDA,
    ACS_ACCOUNT     ACC
WHERE
    ACC.ACC_NUMBER      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER      <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID   = CDA.ACS_CDA_ACCOUNT_ID AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  FYE,
                    ACS_PERIOD          PER,
                    ACT_MGM_IMPUTATION  MGM
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        MGM.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        MGM.ACS_CDA_ACCOUNT_ID      = CDA.ACS_CDA_ACCOUNT_ID) AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  			FYE,
                    ACS_PERIOD          			PER,
                    ACT_MGM_TOT_BY_PERIOD			TOT
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        TOT.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        TOT.ACS_CDA_ACCOUNT_ID      = CDA.ACS_CDA_ACCOUNT_ID);
end ACR_CDA_IMPUTATION_DET_RPT_PK;


PROCEDURE  ACR_CPN_IMPUTATION_DET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PROCPARAM_0 in     number
, PROCPARAM_1 in     varchar2
, PROCPARAM_2 in     varchar2
, PROCUSER_LANID in  pcs.pc_lang.lanid%type
)

is
/**
* Proc¨¦dure stock¨¦e utilis¨¦e pour les rapports ACR_CPN_IMPUTATION_DET et ACR_CPN_IMPUTATION_DET_FC
* (Mouvements CPN sans et avec ME)
*/
begin

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);

open aRefCursor for
SELECT
    'REEL' INFO,
    MGM.ACT_MGM_IMPUTATION_ID ACT_MGM_IMPUTATION_ID,
    MGM.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    MGM.IMM_TRANSACTION_DATE IMM_TRANSACTION_DATE,
    MGM.IMM_VALUE_DATE IMM_VALUE_DATE,
    MGM.IMM_DESCRIPTION IMM_DESCRIPTION,
    MGM.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(MGM.ACS_CPN_ACCOUNT_ID) CPN_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',MGM.ACS_CPN_ACCOUNT_ID) CPN_LARGE_DESCR,
    MGM.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    MGM.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    DIS.ACT_MGM_DISTRIBUTION_ID ACT_MGM_DISTRIBUTION_ID,
    DIS.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(DIS.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    MGM.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    MGM.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    MGM.IMM_AMOUNT_LC_D IMM_AMOUNT_LC_D,
    MGM.IMM_AMOUNT_LC_C IMM_AMOUNT_LC_C,
    MGM.IMM_AMOUNT_FC_D IMM_AMOUNT_FC_D,
    MGM.IMM_AMOUNT_FC_C IMM_AMOUNT_FC_C,
    MGM.ACS_PERIOD_ID ACS_PERIOD_ID,
    IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(IMP.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
     FROM ACT_ETAT_JOURNAL ETA
     WHERE ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
           ETA.C_SUB_SET      = 'CPN') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
     FROM ACJ_SUB_SET_CAT SCA
     WHERE SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
           SCA.C_SUB_SET                 = 'CPN') C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CPN.ACS_CPN_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACT_JOURNAL              JOU,
    ACT_DOCUMENT             DOC,
    ACS_PERIOD               PER,
    ACS_FINANCIAL_YEAR       FYE,
    ACT_FINANCIAL_IMPUTATION IMP,
    ACT_MGM_DISTRIBUTION     DIS,
    ACT_MGM_IMPUTATION       MGM,
    ACS_ACCOUNT              ACC,
    ACS_CPN_ACCOUNT          CPN
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    CPN.ACS_CPN_ACCOUNT_ID              = ACC.ACS_ACCOUNT_ID AND
    CPN.ACS_CPN_ACCOUNT_ID              = MGM.ACS_CPN_ACCOUNT_ID (+) AND
    MGM.ACT_FINANCIAL_IMPUTATION_ID     = IMP.ACT_FINANCIAL_IMPUTATION_ID (+) AND
    MGM.ACT_MGM_IMPUTATION_ID           = DIS.ACT_MGM_IMPUTATION_ID (+) AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    MGM.ACS_PERIOD_ID                   = PER.ACS_PERIOD_ID AND
    MGM.ACT_DOCUMENT_ID                 = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_ACT_JOURNAL_ID              = JOU.ACT_JOURNAL_ID
UNION ALL
SELECT
    'REPORT' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    FYE.FYE_START_DATE IMM_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMM_VALUE_DATE,
    'Report' IMM_DESCRIPTION,
    TOT.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_CPN_ACCOUNT_ID) CPN_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',TOT.ACS_CPN_ACCOUNT_ID) CPN_LARGE_DESCR,
    TOT.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    TOT.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    TOT.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    TOT.MTO_DEBIT_LC IMM_AMOUNT_LC_D,
    TOT.MTO_CREDIT_LC IMM_AMOUNT_LC_C,
    TOT.MTO_DEBIT_FC IMM_AMOUNT_FC_D,
    TOT.MTO_CREDIT_FC IMM_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CPN.ACS_CPN_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR FYE,
    ACS_PERIOD PER,
    ACS_CPN_ACCOUNT CPN,
    ACS_ACCOUNT ACC,
    ACT_MGM_TOT_BY_PERIOD TOT
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    CPN.ACS_CPN_ACCOUNT_ID              = ACC.ACS_ACCOUNT_ID AND
    CPN.ACS_CPN_ACCOUNT_ID              = TOT.ACS_CPN_ACCOUNT_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID                   = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD                   = '1'
UNION ALL
SELECT
    'BUDGET' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    GLO.ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_CPN_ACCOUNT_ID) CPN_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',GLO.ACS_CPN_ACCOUNT_ID) CPN_LARGE_DESCR,
    GLO.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    GLO.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    GLO.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(GLO.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CPN.ACS_CPN_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR FYE,
    ACS_PERIOD PER,
    ACB_PERIOD_AMOUNT PERB,
    ACB_GLOBAL_BUDGET GLO,
    ACB_BUDGET_VERSION VER,
    ACB_BUDGET BUD,
    ACS_ACCOUNT ACC,
    ACS_CPN_ACCOUNT CPN
WHERE
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID                   = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT                     = 1 AND
    VER.ACB_BUDGET_VERSION_ID           = GLO.ACB_BUDGET_VERSION_ID AND
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID                  = CPN.ACS_CPN_ACCOUNT_ID AND
    CPN.ACS_CPN_ACCOUNT_ID              = GLO.ACS_CPN_ACCOUNT_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID            = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID                  = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID           = FYE.ACS_FINANCIAL_YEAR_ID
UNION ALL
SELECT
    'VIDE' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    CPN.ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(CPN.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(CPN.ACS_CPN_ACCOUNT_ID) CPN_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',CPN.ACS_CPN_ACCOUNT_ID) CPN_LARGE_DESCR,
    0 ACS_CDA_ACCOUNT_ID,
    NULL CDA_NUMBER,
    0 ACS_PF_ACCOUNT_ID,
    NULL PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    0 ACS_PJ_ACCOUNT_ID,
    NULL PJ_NUMBER,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    0 ACS_FINANCIAL_ACCOUNT_ID,
    NULL FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = CPN.ACS_CPN_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_CPN_ACCOUNT CPN,
    ACS_ACCOUNT     ACC
WHERE
    ACC.ACC_NUMBER      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER      <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID   = CPN.ACS_CPN_ACCOUNT_ID AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  FYE,
                    ACS_PERIOD          PER,
                    ACT_MGM_IMPUTATION  MGM
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        MGM.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        MGM.ACS_CPN_ACCOUNT_ID      = CPN.ACS_CPN_ACCOUNT_ID) AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  			FYE,
                    ACS_PERIOD          			PER,
                    ACT_MGM_TOT_BY_PERIOD			TOT
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        TOT.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        TOT.ACS_CPN_ACCOUNT_ID      = CPN.ACS_CPN_ACCOUNT_ID);
end ACR_CPN_IMPUTATION_DET_RPT_PK;


PROCEDURE ACR_PF_IMPUTATION_DET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PROCPARAM_0 in     number
, PROCPARAM_1 in     varchar2
, PROCPARAM_2 in     varchar2
, PROCUSER_LANID in  pcs.pc_lang.lanid%type
)

is
/**
* Proc¨¦dure stock¨¦e utilis¨¦e pour les rapports ACR_PF_IMPUTATION_DET et ACR_PF_IMPUTATION_DET_FC
*                                 (Mouvements PF sans et avec ME)
*/
begin

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);

open aRefCursor for
SELECT
    'REEL' INFO,
    MGM.ACT_MGM_IMPUTATION_ID ACT_MGM_IMPUTATION_ID,
    MGM.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    MGM.IMM_TRANSACTION_DATE IMM_TRANSACTION_DATE,
    MGM.IMM_VALUE_DATE IMM_VALUE_DATE,
    MGM.IMM_DESCRIPTION IMM_DESCRIPTION,
    MGM.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(MGM.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    MGM.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    MGM.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(MGM.ACS_PF_ACCOUNT_ID) PF_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',MGM.ACS_PF_ACCOUNT_ID) PF_LARGE_DESCR,
    DIS.ACT_MGM_DISTRIBUTION_ID ACT_MGM_DISTRIBUTION_ID,
    DIS.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(DIS.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    MGM.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    MGM.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    MGM.IMM_AMOUNT_LC_D IMM_AMOUNT_LC_D,
    MGM.IMM_AMOUNT_LC_C IMM_AMOUNT_LC_C,
    MGM.IMM_AMOUNT_FC_D IMM_AMOUNT_FC_D,
    MGM.IMM_AMOUNT_FC_C IMM_AMOUNT_FC_C,
    MGM.ACS_PERIOD_ID ACS_PERIOD_ID,
    IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(IMP.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
     FROM ACT_ETAT_JOURNAL ETA
     WHERE ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
           ETA.C_SUB_SET      = 'CPN') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
     FROM ACJ_SUB_SET_CAT SCA
     WHERE SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
           SCA.C_SUB_SET                 = 'CPN') C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PF.ACS_PF_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACT_JOURNAL              JOU,
    ACT_DOCUMENT             DOC,
    ACS_PERIOD               PER,
    ACS_FINANCIAL_YEAR       FYE,
    ACT_FINANCIAL_IMPUTATION IMP,
    ACT_MGM_DISTRIBUTION     DIS,
    ACT_MGM_IMPUTATION       MGM,
    ACS_ACCOUNT              ACC,
    ACS_PF_ACCOUNT           PF
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    PF.ACS_PF_ACCOUNT_ID                = ACC.ACS_ACCOUNT_ID AND
    PF.ACS_PF_ACCOUNT_ID                = MGM.ACS_PF_ACCOUNT_ID (+) AND
    MGM.ACT_FINANCIAL_IMPUTATION_ID     = IMP.ACT_FINANCIAL_IMPUTATION_ID (+) AND
    MGM.ACT_MGM_IMPUTATION_ID           = DIS.ACT_MGM_IMPUTATION_ID (+) AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    MGM.ACS_PERIOD_ID                   = PER.ACS_PERIOD_ID AND
    MGM.ACT_DOCUMENT_ID                 = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_ACT_JOURNAL_ID              = JOU.ACT_JOURNAL_ID
UNION ALL
SELECT
    'REPORT' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    FYE.FYE_START_DATE IMM_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMM_VALUE_DATE,
    'Report' IMM_DESCRIPTION,
    TOT.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    TOT.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    TOT.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_PF_ACCOUNT_ID) PF_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',TOT.ACS_PF_ACCOUNT_ID) PF_LARGE_DESCR,
    0 ACT_MGM_DISTRIBUTION_ID,
    TOT.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    TOT.MTO_DEBIT_LC IMM_AMOUNT_LC_D,
    TOT.MTO_CREDIT_LC IMM_AMOUNT_LC_C,
    TOT.MTO_DEBIT_FC IMM_AMOUNT_FC_D,
    TOT.MTO_CREDIT_FC IMM_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PF.ACS_PF_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR FYE,
    ACS_PERIOD PER,
    ACS_PF_ACCOUNT PF,
    ACS_ACCOUNT ACC,
    ACT_MGM_TOT_BY_PERIOD TOT
WHERE
    ACC.ACC_NUMBER                      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                      <= PROCPARAM_2 AND
    PF.ACS_PF_ACCOUNT_ID                = ACC.ACS_ACCOUNT_ID AND
    PF.ACS_PF_ACCOUNT_ID                = TOT.ACS_PF_ACCOUNT_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID                   = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD                   = '1'
UNION ALL
SELECT
    'BUDGET' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    GLO.ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    GLO.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    GLO.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_PF_ACCOUNT_ID) PF_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',GLO.ACS_PF_ACCOUNT_ID) PF_LARGE_DESCR,
    0 ACT_MGM_DISTRIBUTION_ID,
    GLO.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(GLO.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PF.ACS_PF_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR  FYE,
    ACS_PERIOD          PER,
    ACB_PERIOD_AMOUNT   PERB,
    ACB_GLOBAL_BUDGET   GLO,
    ACB_BUDGET_VERSION  VER,
    ACB_BUDGET          BUD,
    ACS_ACCOUNT         ACC,
    ACS_PF_ACCOUNT      PF
WHERE
    FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID   = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID           = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT             = 1 AND
    VER.ACB_BUDGET_VERSION_ID   = GLO.ACB_BUDGET_VERSION_ID AND
    ACC.ACC_NUMBER              >= PROCPARAM_1 AND
    ACC.ACC_NUMBER              <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID          = PF.ACS_PF_ACCOUNT_ID AND
    PF.ACS_PF_ACCOUNT_ID        = GLO.ACS_PF_ACCOUNT_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID    = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID          = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID   = FYE.ACS_FINANCIAL_YEAR_ID
UNION ALL
SELECT
    'VIDE' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    0 ACS_CPN_ACCOUNT_ID,
    NULL CPN_NUMBER,
    NULL CPN_DESCR,
    0 ACS_CDA_ACCOUNT_ID,
    NULL CDA_NUMBER,
    0 ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(PF.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(PF.ACS_PF_ACCOUNT_ID) PF_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',PF.ACS_PF_ACCOUNT_ID) PF_LARGE_DESCR,
    0 ACT_MGM_DISTRIBUTION_ID,
    0 ACS_PJ_ACCOUNT_ID,
    NULL PJ_NUMBER,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 IMM_AMOUNT_LC_D,
    0 IMM_AMOUNT_LC_C,
    0 IMM_AMOUNT_FC_D,
    0 IMM_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    0 ACS_FINANCIAL_ACCOUNT_ID,
    NULL FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PF.ACS_PF_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_PF_ACCOUNT  PF,
    ACS_ACCOUNT     ACC
WHERE
    ACC.ACC_NUMBER      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER      <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID   = PF.ACS_PF_ACCOUNT_ID AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  FYE,
                    ACS_PERIOD          PER,
                    ACT_MGM_IMPUTATION  MGM
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        MGM.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        MGM.ACS_PF_ACCOUNT_ID       = PF.ACS_PF_ACCOUNT_ID)AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  			FYE,
                    ACS_PERIOD          			PER,
                    ACT_MGM_TOT_BY_PERIOD			TOT
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        TOT.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        TOT.ACS_PF_ACCOUNT_ID       = PF.ACS_PF_ACCOUNT_ID);
end ACR_PF_IMPUTATION_DET_RPT_PK;



PROCEDURE ACR_PJ_IMPUTATION_DET_RPT_PK (
  aRefCursor  in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, PROCPARAM_0 in     number
, PROCPARAM_1 in     varchar2
, PROCPARAM_2 in     varchar2
, PROCUSER_LANID in  pcs.pc_lang.lanid%type
)

is
/**
* Proc¨¦dure stock¨¦e utilis¨¦e pour les rapports ACR_PJ_IMPUTATION_DET et ACR_PJ_IMPUTATION_DET_FC
*                                 (Mouvements PJ sans et avec ME)
*/
begin

pcs.PC_I_LIB_SESSION.setLanId (procuser_lanid);

open aRefCursor for
SELECT
    'REEL' INFO,
    MGM.ACT_MGM_IMPUTATION_ID ACT_MGM_IMPUTATION_ID,
    MGM.ACT_FINANCIAL_IMPUTATION_ID ACT_FINANCIAL_IMPUTATION_ID,
    MGM.IMM_TRANSACTION_DATE IMM_TRANSACTION_DATE,
    MGM.IMM_VALUE_DATE IMM_VALUE_DATE,
    MGM.IMM_DESCRIPTION IMM_DESCRIPTION,
    MGM.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(MGM.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    MGM.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    MGM.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(MGM.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    DIS.ACT_MGM_DISTRIBUTION_ID ACT_MGM_DISTRIBUTION_ID,
    DIS.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(DIS.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(DIS.ACS_PJ_ACCOUNT_ID) PJ_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',DIS.ACS_PJ_ACCOUNT_ID) PJ_LARGE_DESCR,
    MGM.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    MGM.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(MGM.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    DIS.MGM_AMOUNT_LC_D MGM_AMOUNT_LC_D,
    DIS.MGM_AMOUNT_LC_C MGM_AMOUNT_LC_C,
    DIS.MGM_AMOUNT_FC_D MGM_AMOUNT_FC_D,
    DIS.MGM_AMOUNT_FC_C MGM_AMOUNT_FC_C,
    MGM.ACS_PERIOD_ID ACS_PERIOD_ID,
    IMP.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(IMP.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID) ACS_AUXILIARY_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(ACT_FUNCTIONS.AuxAccountFromImputation(IMP.ACT_FINANCIAL_IMPUTATION_ID)) AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    DOC.ACT_DOCUMENT_ID ACT_DOCUMENT_ID,
    DOC.DOC_NUMBER DOC_NUMBER,
    DOC.ACT_ACT_JOURNAL_ID ACT_ACT_JOURNAL_ID,
    JOU.ACT_JOURNAL_ID ACT_JOURNAL_ID,
    JOU.JOU_NUMBER JOU_NUMBER,
    JOU.JOU_DESCRIPTION JOU_DESCRIPTION,
    (SELECT ETA.C_ETAT_JOURNAL
     FROM ACT_ETAT_JOURNAL ETA
     WHERE ETA.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID AND
           ETA.C_SUB_SET      = 'CPN') C_ETAT_JOURNAL,
    (SELECT SCA.C_TYPE_CUMUL
     FROM ACJ_SUB_SET_CAT SCA
     WHERE SCA.ACJ_CATALOGUE_DOCUMENT_ID = DOC.ACJ_CATALOGUE_DOCUMENT_ID AND
           SCA.C_SUB_SET                 = 'CPN') C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PJ.ACS_PJ_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    JOU.C_TYPE_JOURNAL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACT_JOURNAL              JOU,
    ACT_DOCUMENT             DOC,
    ACS_PERIOD               PER,
    ACS_FINANCIAL_YEAR       FYE,
    ACT_FINANCIAL_IMPUTATION IMP,
    ACT_MGM_DISTRIBUTION     DIS,
    ACT_MGM_IMPUTATION       MGM,
    ACS_ACCOUNT              ACC,
    ACS_PJ_ACCOUNT           PJ
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    PJ.ACS_PJ_ACCOUNT_ID                = ACC.ACS_ACCOUNT_ID AND
    PJ.ACS_PJ_ACCOUNT_ID                = DIS.ACS_PJ_ACCOUNT_ID AND
    MGM.ACT_FINANCIAL_IMPUTATION_ID     = IMP.ACT_FINANCIAL_IMPUTATION_ID (+) AND
    MGM.ACT_MGM_IMPUTATION_ID           = DIS.ACT_MGM_IMPUTATION_ID (+) AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    MGM.ACS_PERIOD_ID                   = PER.ACS_PERIOD_ID AND
    MGM.ACT_DOCUMENT_ID                 = DOC.ACT_DOCUMENT_ID AND
    DOC.ACT_ACT_JOURNAL_ID              = JOU.ACT_JOURNAL_ID
UNION ALL
SELECT
    'REPORT' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    FYE.FYE_START_DATE IMM_TRANSACTION_DATE,
    FYE.FYE_START_DATE IMM_VALUE_DATE,
    'Report' IMM_DESCRIPTION,
    TOT.ACS_CPN_ACCOUNT_ID ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    TOT.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    TOT.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    TOT.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(TOT.ACS_PJ_ACCOUNT_ID) PJ_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',TOT.ACS_PJ_ACCOUNT_ID) PJ_LARGE_DESCR,
    TOT.ACS_ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    TOT.ACS_FINANCIAL_CURRENCY_ID ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(TOT.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_ME,
    TOT.MTO_DEBIT_LC MGM_AMOUNT_LC_D,
    TOT.MTO_CREDIT_LC MGM_AMOUNT_LC_C,
    TOT.MTO_DEBIT_FC MGM_AMOUNT_FC_D,
    TOT.MTO_CREDIT_FC MGM_AMOUNT_FC_C,
    TOT.ACS_PERIOD_ID ACS_PERIOD_ID,
    TOT.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(TOT.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    PER.C_TYPE_PERIOD C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    TOT.C_TYPE_CUMUL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PJ.ACS_PJ_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR FYE,
    ACS_PERIOD PER,
    ACS_PJ_ACCOUNT PJ,
    ACS_ACCOUNT ACC,
    ACT_MGM_TOT_BY_PERIOD TOT
WHERE
    ACC.ACC_NUMBER                     >= PROCPARAM_1 AND
    ACC.ACC_NUMBER                     <= PROCPARAM_2 AND
    PJ.ACS_PJ_ACCOUNT_ID                = ACC.ACS_ACCOUNT_ID AND
    PJ.ACS_PJ_ACCOUNT_ID                = TOT.ACS_PJ_ACCOUNT_ID AND
    ACS_FUNCTION.GetStatePreviousFinancialYear(FYE.ACS_FINANCIAL_YEAR_ID) = 'ACT' AND
    FYE.FYE_NO_EXERCICE                 = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID           = PER.ACS_FINANCIAL_YEAR_ID AND
    PER.ACS_PERIOD_ID                   = TOT.ACS_PERIOD_ID AND
    PER.C_TYPE_PERIOD                   = '1'
UNION ALL
SELECT
    'BUDGET' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    GLO.ACS_CPN_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CPN_ACCOUNT_ID) CPN_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_CPN_ACCOUNT_ID) CPN_DESCR,
    GLO.ACS_CDA_ACCOUNT_ID ACS_CDA_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_CDA_ACCOUNT_ID) CDA_NUMBER,
    GLO.ACS_PF_ACCOUNT_ID ACS_PF_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PF_ACCOUNT_ID) PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    GLO.ACS_PJ_ACCOUNT_ID ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(GLO.ACS_PJ_ACCOUNT_ID) PJ_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',GLO.ACS_PJ_ACCOUNT_ID) PJ_LARGE_DESCR,
    GLO.ACS_FINANCIAL_CURRENCY_ID ACS_ACS_FINANCIAL_CURRENCY_ID,
    ACS_FUNCTION.GetCurrencyName(GLO.ACS_FINANCIAL_CURRENCY_ID) CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 MGM_AMOUNT_LC_D,
    0 MGM_AMOUNT_LC_C,
    0 MGM_AMOUNT_FC_D,
    0 MGM_AMOUNT_FC_C,
    PERB.ACS_PERIOD_ID ACS_PERIOD_ID,
    GLO.ACS_FINANCIAL_ACCOUNT_ID ACS_FINANCIAL_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(GLO.ACS_FINANCIAL_ACCOUNT_ID) FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    FYE.ACS_FINANCIAL_YEAR_ID ACS_FINANCIAL_YEAR_ID,
    PER.PER_START_DATE PER_START_DATE,
    PER.PER_END_DATE PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    NULL C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PJ.ACS_PJ_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    PERB.PER_AMOUNT_D PER_AMOUNT_D,
    PERB.PER_AMOUNT_C PER_AMOUNT_C,
    BUD.ACB_BUDGET_ID ACB_BUDGET_ID,
    VER.ACB_BUDGET_VERSION_ID ACB_BUDGET_VERSION_ID,
    GLO.ACB_GLOBAL_BUDGET_ID ACB_GLOBAL_BUDGET_ID
FROM
    ACS_FINANCIAL_YEAR      FYE,
    ACS_PERIOD              PER,
    ACB_PERIOD_AMOUNT       PERB,
    ACB_GLOBAL_BUDGET       GLO,
    ACB_BUDGET_VERSION      VER,
    ACB_BUDGET              BUD,
    ACS_ACCOUNT             ACC,
    ACS_PJ_ACCOUNT          PJ
WHERE
    FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
    FYE.ACS_FINANCIAL_YEAR_ID   = BUD.ACS_FINANCIAL_YEAR_ID AND
    BUD.ACB_BUDGET_ID           = VER.ACB_BUDGET_ID AND
    VER.VER_DEFAULT             = 1 AND
    VER.ACB_BUDGET_VERSION_ID   = GLO.ACB_BUDGET_VERSION_ID AND
    ACC.ACC_NUMBER              >= PROCPARAM_1 AND
    ACC.ACC_NUMBER              <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID          = PJ.ACS_PJ_ACCOUNT_ID AND
    PJ.ACS_PJ_ACCOUNT_ID        = GLO.ACS_PJ_ACCOUNT_ID AND
    GLO.ACB_GLOBAL_BUDGET_ID    = PERB.ACB_GLOBAL_BUDGET_ID AND
    PERB.ACS_PERIOD_ID          = PER.ACS_PERIOD_ID AND
    PER.ACS_FINANCIAL_YEAR_ID   = FYE.ACS_FINANCIAL_YEAR_ID
UNION ALL
SELECT
    'VIDE' INFO,
    0 ACT_MGM_IMPUTATION_ID,
    0 ACT_FINANCIAL_IMPUTATION_ID,
    NULL IMM_TRANSACTION_DATE,
    NULL IMM_VALUE_DATE,
    NULL IMM_DESCRIPTION,
    0 ACS_CPN_ACCOUNT_ID,
    NULL CPN_NUMBER,
    NULL CPN_DESCR,
    0 ACS_CDA_ACCOUNT_ID,
    NULL CDA_NUMBER,
    0 ACS_PF_ACCOUNT_ID,
    NULL PF_NUMBER,
    0 ACT_MGM_DISTRIBUTION_ID,
    0 ACS_PJ_ACCOUNT_ID,
    ACS_FUNCTION.GetAccountNumber(PJ.ACS_PJ_ACCOUNT_ID) PJ_NUMBER,
    ACS_FUNCTION.GetAccountDescriptionSummary(PJ.ACS_PJ_ACCOUNT_ID) PJ_SHORT_DESCR,
    ACS_FUNCTION.GetLargeDescription('ACS_ACCOUNT_ID',PJ.ACS_PJ_ACCOUNT_ID) PJ_LARGE_DESCR,
    0 ACS_ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_MB,
    0 ACS_FINANCIAL_CURRENCY_ID,
    NULL CURRENCY_ME,
    0 MGM_AMOUNT_LC_D,
    0 MGM_AMOUNT_LC_C,
    0 MGM_AMOUNT_FC_D,
    0 MGM_AMOUNT_FC_C,
    0 ACS_PERIOD_ID,
    0 ACS_FINANCIAL_ACCOUNT_ID,
    NULL FIN_NUMBER,
    0 ACS_AUXILIARY_ACCOUNT_ID,
    NULL AUX_NUMBER,
    NULL AUX_SHORT_DESCR,
    0 ACS_FINANCIAL_YEAR_ID,
    NULL PER_START_DATE,
    NULL PER_END_DATE,
    NULL C_TYPE_PERIOD,
    0 ACT_DOCUMENT_ID,
    NULL DOC_NUMBER,
    0 ACT_ACT_JOURNAL_ID,
    0 ACT_JOURNAL_ID,
    0 JOU_NUMBER,
    NULL JOU_DESCRIPTION,
    'PROV' C_ETAT_JOURNAL,
    NULL C_TYPE_CUMUL,
    (SELECT ACC.ACC_DETAIL_PRINTING
     FROM ACS_ACCOUNT ACC
     WHERE ACC.ACS_ACCOUNT_ID = PJ.ACS_PJ_ACCOUNT_ID) ACC_DETAIL_PRINTING,
    NULL C_TYPE_JOURNAL,
    0 PER_AMOUNT_D,
    0 PER_AMOUNT_C,
    0 ACB_BUDGET_ID,
    0 ACB_BUDGET_VERSION_ID,
    0 ACB_GLOBAL_BUDGET_ID
FROM
    ACS_PJ_ACCOUNT  PJ,
    ACS_ACCOUNT     ACC
WHERE
    ACC.ACC_NUMBER      >= PROCPARAM_1 AND
    ACC.ACC_NUMBER      <= PROCPARAM_2 AND
    ACC.ACS_ACCOUNT_ID   = PJ.ACS_PJ_ACCOUNT_ID AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR      FYE,
                    ACS_PERIOD              PER,
                    ACT_MGM_DISTRIBUTION    DIS,
                    ACT_MGM_IMPUTATION      MGM
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        MGM.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        MGM.ACT_MGM_IMPUTATION_ID   = DIS.ACT_MGM_IMPUTATION_ID AND
                        DIS.ACS_PJ_ACCOUNT_ID       = PJ.ACS_PJ_ACCOUNT_ID) AND
    NOT EXISTS(SELECT 1
               FROM ACS_FINANCIAL_YEAR  			FYE,
                    ACS_PERIOD          			PER,
                    ACT_MGM_TOT_BY_PERIOD			TOT
                WHERE   FYE.FYE_NO_EXERCICE         = PROCPARAM_0 AND
                        FYE.ACS_FINANCIAL_YEAR_ID   = PER.ACS_FINANCIAL_YEAR_ID AND
                        TOT.ACS_PERIOD_ID           = PER.ACS_PERIOD_ID AND
                        TOT.ACS_PJ_ACCOUNT_ID       = PJ.ACS_PJ_ACCOUNT_ID);
end ACR_PJ_IMPUTATION_DET_RPT_PK;




/** Description
* Procedure used for report V_ACT_FINANCIAL_IMPUTATION_CUMUL.RPT,the sub report of ACR_ACC_IMPUTATION_COMPARE.rpt
*/
PROCEDURE ACT_FIN_IMP_CUMUL_SUB_RPT_PK (
  aRefCursor    in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, date_to       in     VARCHAR2
--, PARAMETER_2   in     VARCHAR2
, PARAMETER_0   in     VARCHAR2
, PARAMETER_8   in     VARCHAR2
, PARAMETER_9   in     VARCHAR2
, PARAMETER_10  in     VARCHAR2
, PARAMETER_11  in     VARCHAR2
, PARAMETER_12  in     VARCHAR2
, PARAMETER_14  in     VARCHAR2
, PARAMETER_16  in     VARCHAR2
, PARAMETER_18  in     VARCHAR2
, PARAMETER_19  in     VARCHAR2
, PARAMETER_20  in     VARCHAR2
)
is


VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;

begin
open aRefCursor for
SELECT
CAT.ACJ_CATALOGUE_DOCUMENT_ID,
ACC_S.ACS_FINANCIAL_CURRENCY_ID S_ACS_FINANCIAL_CURRENCY_ID,
CUR.FIN_LOCAL_CURRENCY,
JOU.C_TYPE_JOURNAL,
PCR.CURRENCY,
PCR2.CURRENCY CURRENCY_LC,
V_IMP.ACS_FINANCIAL_ACCOUNT_ID,
V_IMP.IMF_AMOUNT_LC_D,
V_IMP.IMF_AMOUNT_LC_C,
V_IMP.IMF_AMOUNT_FC_D,
V_IMP.IMF_AMOUNT_FC_C,
V_IMP.IMF_TRANSACTION_DATE,
V_IMP.IMF_COMPARE_DATE,
V_IMP.ACS_FINANCIAL_CURRENCY_ID V_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACT_JOURNAL_ID
FROM
    ACJ_CATALOGUE_DOCUMENT CAT,
    ACJ_SUB_SET_CAT SUB,
    ACS_FIN_ACCOUNT_S_FIN_CURR ACC_S,
    ACS_FINANCIAL_CURRENCY CUR,
    ACS_FINANCIAL_CURRENCY CUL,
    ACT_DOCUMENT DOC,
    ACT_JOURNAL JOU,
    PCS.PC_CURR PCR,
    PCS.PC_CURR PCR2,
    V_ACT_ACC_IMP_REPORT V_IMP,
    THE (SELECT CAST(DOC_DOCUMENT_LIST_FUNCTIONS.IN_LIST(PARAMETER_14) AS CHAR_TABLE_TYPE) FROM DUAL) DIVISION_ACCOUNT_ID_LIST
WHERE
V_IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID(+)
AND DOC.ACJ_CATALOGUE_DOCUMENT_ID = SUB.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND DOC.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = ACC_S.ACS_FINANCIAL_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = ACC_S.ACS_FINANCIAL_CURRENCY_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = CUR.ACS_FINANCIAL_CURRENCY_ID
AND CUR.PC_CURR_ID = PCR.PC_CURR_ID(+)
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = CUL.ACS_FINANCIAL_CURRENCY_ID
AND CUL.PC_CURR_ID = PCR2.PC_CURR_ID
AND V_IMP.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(date_to,'yyyyMMdd')
AND DECODE(SUB.C_SUB_SET,NULL,1,'ACC',1,0)=1
AND (PARAMETER_14 = '#' OR V_IMP.ACS_DIVISION_ACCOUNT_ID = DIVISION_ACCOUNT_ID_LIST.COLUMN_VALUE)
AND DECODE(PARAMETER_8,'1',
          DECODE(V_IMP.IMF_TYPE,'VAT',0,DECODE(V_IMP.ACS_TAX_CODE_ID,NULL,1,0)),
          DECODE(V_IMP.IMF_TYPE,NULL,0,1))=1
AND ((PARAMETER_10='1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_11='1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
    OR (PARAMETER_12='1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND DECODE(PARAMETER_16,'0',1,'1',DECODE(V_IMP.IMF_COMPARE_DATE,NULL,0,1),'2',DECODE(V_IMP.IMF_COMPARE_DATE,NULL,1,0),0)=1
AND DECODE(V_IMP.C_TYPE_CUMUL,'INT',DECODE(PARAMETER_9,'1',1,0),'EXT',DECODE(PARAMETER_18,'1',1,0),'PRE',DECODE(PARAMETER_19,'1',1,0),'ENG',DECODE(PARAMETER_20,'1',1,0),0)=1
AND DECODE(V_IMP.ACT_JOURNAL_ID,'NULL',0,DECODE(JOU.C_TYPE_JOURNAL,'OPB',0,1))=1
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = TO_NUMBER(PARAMETER_0)
;
end ACT_FIN_IMP_CUMUL_SUB_RPT_PK;



/** Description
* Procedure used for report V_ACT_FINANCIAL_IMPUTATION_CUMUL.RPT-01,the sub report of ACR_ACC_IMPUTATION_COMPARE.rpt
*/
PROCEDURE ACT_FIN_IMP_CML_DIV_SUB_RPT_PK (
  aRefCursor    in out CRYSTAL_CURSOR_TYPES.DualCursorTyp
, date_to       in     VARCHAR2
--, PARAMETER_2   in     VARCHAR2
, PARAMETER_0   in     VARCHAR2
, PARAMETER_1   in     VARCHAR2
, PARAMETER_8   in     VARCHAR2
, PARAMETER_9   in     VARCHAR2
, PARAMETER_10  in     VARCHAR2
, PARAMETER_11  in     VARCHAR2
, PARAMETER_12  in     VARCHAR2
, PARAMETER_18  in     VARCHAR2
, PARAMETER_19  in     VARCHAR2
, PARAMETER_20  in     VARCHAR2
)
is


VPC_LANG_ID pcs.pc_lang.pc_lang_id%type;

begin
open aRefCursor for
SELECT
CAT.ACJ_CATALOGUE_DOCUMENT_ID,
ACC_S.ACS_FINANCIAL_CURRENCY_ID S_ACS_FINANCIAL_CURRENCY_ID,
CUR.FIN_LOCAL_CURRENCY,
JOU.C_TYPE_JOURNAL,
PCR.CURRENCY,
PCR2.CURRENCY CURRENCY_LC,
V_IMP.ACS_FINANCIAL_ACCOUNT_ID,
V_IMP.IMF_AMOUNT_LC_D,
V_IMP.IMF_AMOUNT_LC_C,
V_IMP.IMF_AMOUNT_FC_D,
V_IMP.IMF_AMOUNT_FC_C,
V_IMP.IMF_TRANSACTION_DATE,
V_IMP.IMF_COMPARE_DATE,
V_IMP.ACS_FINANCIAL_CURRENCY_ID V_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID,
V_IMP.ACT_JOURNAL_ID,
V_IMP.ACS_DIVISION_ACCOUNT_ID
FROM
    ACJ_CATALOGUE_DOCUMENT CAT,
    ACJ_SUB_SET_CAT SUB,
    ACS_FIN_ACCOUNT_S_FIN_CURR ACC_S,
    ACS_FINANCIAL_CURRENCY CUR,
    ACS_FINANCIAL_CURRENCY CUL,
    ACT_DOCUMENT DOC,
    ACT_JOURNAL JOU,
    PCS.PC_CURR PCR,
    PCS.PC_CURR PCR2,
    V_ACT_ACC_IMP_REPORT V_IMP
WHERE
V_IMP.ACT_DOCUMENT_ID = DOC.ACT_DOCUMENT_ID(+)
AND DOC.ACJ_CATALOGUE_DOCUMENT_ID = SUB.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND DOC.ACT_JOURNAL_ID = JOU.ACT_JOURNAL_ID(+)
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = ACC_S.ACS_FINANCIAL_ACCOUNT_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = ACC_S.ACS_FINANCIAL_CURRENCY_ID(+)
AND V_IMP.ACS_FINANCIAL_CURRENCY_ID = CUR.ACS_FINANCIAL_CURRENCY_ID
AND CUR.PC_CURR_ID = PCR.PC_CURR_ID(+)
AND V_IMP.ACS_ACS_FINANCIAL_CURRENCY_ID = CUL.ACS_FINANCIAL_CURRENCY_ID
AND CUL.PC_CURR_ID = PCR2.PC_CURR_ID
AND V_IMP.ACJ_CATALOGUE_DOCUMENT_ID = CAT.ACJ_CATALOGUE_DOCUMENT_ID(+)
AND V_IMP.IMF_TRANSACTION_DATE <= TO_DATE(date_to,'yyyyMMdd')
AND DECODE(SUB.C_SUB_SET,NULL,1,'ACC',1,0)=1
AND DECODE(PARAMETER_8,'1',
          DECODE(V_IMP.IMF_TYPE,'VAT',0,DECODE(V_IMP.ACS_TAX_CODE_ID,NULL,1,0)),
          DECODE(V_IMP.IMF_TYPE,NULL,0,1))=1
AND ((PARAMETER_10='1' AND V_IMP.C_ETAT_JOURNAL = 'BRO')
    OR (PARAMETER_11='1' AND V_IMP.C_ETAT_JOURNAL = 'PROV')
    OR (PARAMETER_12='1' AND V_IMP.C_ETAT_JOURNAL = 'DEF'))
AND DECODE(V_IMP.C_TYPE_CUMUL,'INT',DECODE(PARAMETER_9,'1',1,0),'EXT',DECODE(PARAMETER_18,'1',1,0),'PRE',DECODE(PARAMETER_19,'1',1,0),'ENG',DECODE(PARAMETER_20,'1',1,0),0)=1
AND DECODE(V_IMP.ACT_JOURNAL_ID,'NULL',0,DECODE(JOU.C_TYPE_JOURNAL,'OPB',0,1))=1
AND V_IMP.ACS_FINANCIAL_ACCOUNT_ID = TO_NUMBER(PARAMETER_0)
AND V_IMP.ACS_DIVISION_ACCOUNT_ID = TO_NUMBER(PARAMETER_1)
;
end ACT_FIN_IMP_CML_DIV_SUB_RPT_PK;



/**
*DESCRIPTION
USED FOR REPORT ACR_BALANCE_THREE_COL.RPT
*/
PROCEDURE  ACR_BALANCE_3_COL_RPT_PK (
AREFCURSOR       IN OUT   CRYSTAL_CURSOR_TYPES.DUALCURSORTYP,
PROCUSER_LANID   IN       PCS.PC_LANG.LANID%TYPE,
PARAMETER_0      IN       VARCHAR2,
PARAMETER_1      IN       NUMBER,
PARAMETER_4      IN       NUMBER,
PARAMETER_5      IN       NUMBER,
PARAMETER_8      IN       NUMBER,
PARAMETER_9      IN       NUMBER,
PARAMETER_12     IN       NUMBER,
PARAMETER_14     IN       VARCHAR2,
PARAMETER_24     IN       VARCHAR2,
PARAMETER_29     IN       VARCHAR2
--ACCOUNT_FROM     IN       VARCHAR2,
--ACCOUNT_TO       IN       VARCHAR2
)
IS

VPC_LANG_ID   PCS.PC_LANG.PC_LANG_ID%TYPE;              --USER LANGUAGE ID

PARAM_14 NUMBER;
PARAM_24 NUMBER;
PARAM_29 NUMBER;

V_FYE_NO_EXERCICE    NUMBER(9);
V_FYE_NO_EXERCICE_1  NUMBER(9);
V_FYE_NO_EXERCICE_2  NUMBER(9);

C_FYE_NO_EXERCICE   NUMBER(2);
C_FYE_NO_EXERCICE_1 NUMBER(2);
C_FYE_NO_EXERCICE_2 NUMBER(2);

V_CURRENCY VARCHAR2(5 CHAR);

V_VER_NUMBER   VARCHAR2(30 CHAR);
V_VER_NUMBER_1 VARCHAR2(30 CHAR);
V_VER_NUMBER_2 VARCHAR2(30 CHAR);

C_VER_NUMBER   NUMBER(2);
C_VER_NUMBER_1 NUMBER(2);
C_VER_NUMBER_2 NUMBER(2);

BEGIN
PCS.PC_I_LIB_SESSION.SETLANID (PROCUSER_LANID);
VPC_LANG_ID := PCS.PC_I_LIB_SESSION.GETUSERLANGID;

IF PARAMETER_14 = '#'
THEN PARAM_14 := -1;
ELSE PARAM_14 := PARAMETER_14;
END IF;

IF PARAMETER_24 = '#'
THEN PARAM_24 := -1;
ELSE PARAM_24 := PARAMETER_24;
END IF;

IF PARAMETER_29 = '#'
THEN PARAM_29 := -1;
ELSE PARAM_29 := PARAMETER_29;
END IF;

SELECT
COUNT(FYE.FYE_NO_EXERCICE) INTO C_FYE_NO_EXERCICE
FROM
ACS_FINANCIAL_YEAR FYE
WHERE
FYE.ACS_FINANCIAL_YEAR_ID = PARAMETER_1;

IF C_FYE_NO_EXERCICE = 0
THEN V_FYE_NO_EXERCICE := NULL;
ELSE
SELECT
FYE.FYE_NO_EXERCICE INTO V_FYE_NO_EXERCICE
FROM
ACS_FINANCIAL_YEAR FYE
WHERE
FYE.ACS_FINANCIAL_YEAR_ID = PARAMETER_1;
END IF;

SELECT
COUNT(FYE.FYE_NO_EXERCICE) INTO C_FYE_NO_EXERCICE_1
FROM
ACS_FINANCIAL_YEAR FYE
WHERE
FYE.ACS_FINANCIAL_YEAR_ID = PARAMETER_5;

IF C_FYE_NO_EXERCICE_1 = 0
THEN V_FYE_NO_EXERCICE_1 := NULL;
ELSE
SELECT
FYE.FYE_NO_EXERCICE INTO V_FYE_NO_EXERCICE_1
FROM
ACS_FINANCIAL_YEAR FYE
WHERE
FYE.ACS_FINANCIAL_YEAR_ID = PARAMETER_5;
END IF;

SELECT
COUNT(FYE.FYE_NO_EXERCICE) INTO C_FYE_NO_EXERCICE_2
FROM
ACS_FINANCIAL_YEAR FYE
WHERE
FYE.ACS_FINANCIAL_YEAR_ID = PARAMETER_9;

IF C_FYE_NO_EXERCICE_2 = 0
THEN V_FYE_NO_EXERCICE_2 := NULL;
ELSE
SELECT
FYE.FYE_NO_EXERCICE INTO V_FYE_NO_EXERCICE_2
FROM
ACS_FINANCIAL_YEAR FYE
WHERE
FYE.ACS_FINANCIAL_YEAR_ID = PARAMETER_9;
END IF;

SELECT
CUR.CURRENCY INTO V_CURRENCY
FROM
ACS_FINANCIAL_CURRENCY ACS,
PCS.PC_CURR CUR
WHERE
ACS.PC_CURR_ID = CUR.PC_CURR_ID
AND ACS.FIN_LOCAL_CURRENCY = 1;


SELECT
COUNT(VER.VER_NUMBER) INTO  C_VER_NUMBER
FROM
ACB_BUDGET_VERSION VER
WHERE
VER.ACB_BUDGET_VERSION_ID = PARAMETER_4;

IF C_VER_NUMBER = 0
THEN V_VER_NUMBER := NULL;
ELSE
SELECT
VER.VER_NUMBER INTO  V_VER_NUMBER
FROM
ACB_BUDGET_VERSION VER
WHERE
VER.ACB_BUDGET_VERSION_ID = PARAMETER_4;
END IF;

SELECT
COUNT(VER.VER_NUMBER) INTO  C_VER_NUMBER_1
FROM
ACB_BUDGET_VERSION VER
WHERE
VER.ACB_BUDGET_VERSION_ID = PARAMETER_8;

IF C_VER_NUMBER_1 = 0
THEN V_VER_NUMBER_1 := NULL;
ELSE
SELECT
VER.VER_NUMBER INTO  V_VER_NUMBER_1
FROM
ACB_BUDGET_VERSION VER
WHERE
VER.ACB_BUDGET_VERSION_ID = PARAMETER_8;
END IF;

SELECT
COUNT(VER.VER_NUMBER) INTO  C_VER_NUMBER_2
FROM
ACB_BUDGET_VERSION VER
WHERE
VER.ACB_BUDGET_VERSION_ID = PARAMETER_12;

IF C_VER_NUMBER_2 = 0
THEN V_VER_NUMBER_2 := NULL;
ELSE
SELECT
VER.VER_NUMBER INTO  V_VER_NUMBER_2
FROM
ACB_BUDGET_VERSION VER
WHERE
VER.ACB_BUDGET_VERSION_ID = PARAMETER_12;
END IF;


OPEN AREFCURSOR FOR
SELECT
VER.ACB_BUDGET_VERSION_ID,
PAM.PER_AMOUNT_D,
PAM.PER_AMOUNT_C,
ACC.ACS_ACCOUNT_ID,
ACC.ACC_NUMBER DIVISION_ACC_NUMBER,
PER.ACS_FINANCIAL_YEAR_ID,
PER.PER_NO_PERIOD,
PER_BUD.PER_NO_PERIOD BUD_PER_NO_PERIOD,
TOT.TOT_DEBIT_LC,
TOT.TOT_CREDIT_LC,
TOT.ACS_AUXILIARY_ACCOUNT_ID,
TOT.C_TYPE_CUMUL,
TOT.ACS_DIVISION_ACCOUNT_ID,
CFL.NODE01,
CFL.NODE02,
CFL.NODE03,
CFL.NODE04,
CFL.NODE05,
CFL.NODE06,
CFL.NODE07,
CFL.NODE08,
CFL.NODE09,
CFL.NODE10,
CFL.CLASSIF_LEAF_ID,
CFL.LEAF_DESCR,
VAC.ACC_NUMBER,
VAC.DES_DESCRIPTION_SUMMARY,
VAC.ACS_FINANCIAL_ACCOUNT_ID,
VAC.ISFINACCOUNTINME,
CLA.CLA_DESCR,
ACS_FUNCTION.GetAccountNumber(TO_NUMBER(PARAM_14)) DIV_REF,
ACS_FUNCTION.GetAccountNumber(TO_NUMBER(PARAM_24)) DIV_COMP1,
ACS_FUNCTION.GetAccountNumber(TO_NUMBER(PARAM_29)) DIV_COMP2,
V_FYE_NO_EXERCICE FYE_NO_EXERCICE,
V_FYE_NO_EXERCICE_1 FYE_NO_EXERCICE_1,
V_FYE_NO_EXERCICE_2 FYE_NO_EXERCICE_2,
V_CURRENCY CURRENCY,
V_VER_NUMBER VER_NUMBER,
V_VER_NUMBER_1 VER_NUMBER_1,
V_VER_NUMBER_2 VER_NUMBER_2
FROM ACB_BUDGET_VERSION VER,
ACB_GLOBAL_BUDGET GLO,
ACB_PERIOD_AMOUNT PAM,
ACS_ACCOUNT ACC,
ACS_PERIOD PER,
ACS_PERIOD PER_BUD,
ACT_TOTAL_BY_PERIOD TOT,
CLASSIF_FLAT CFL,
CLASSIFICATION CLA,
(SELECT ACC.ACS_FINANCIAL_ACCOUNT_ID,
TOT.ACS_DIVISION_ACCOUNT_ID,
TOT.ACT_TOTAL_BY_PERIOD_ID ID, 'TOT' TYP,
PER.ACS_FINANCIAL_YEAR_ID, 0 ACB_BUDGET_VERSION_ID
FROM ACS_FINANCIAL_ACCOUNT ACC,
ACT_TOTAL_BY_PERIOD TOT,
ACS_PERIOD PER
WHERE ACC.ACS_FINANCIAL_ACCOUNT_ID =
TOT.ACS_FINANCIAL_ACCOUNT_ID
AND TOT.ACS_PERIOD_ID = PER.ACS_PERIOD_ID
AND TOT.ACS_AUXILIARY_ACCOUNT_ID IS NULL
UNION ALL
SELECT ACC.ACS_FINANCIAL_ACCOUNT_ID,
GLO.ACS_DIVISION_ACCOUNT_ID, AMO.ACB_PERIOD_AMOUNT_ID ID,
'BUD' TYP, PER.ACS_FINANCIAL_YEAR_ID,
GLO.ACB_BUDGET_VERSION_ID
FROM ACS_FINANCIAL_ACCOUNT ACC,
ACB_PERIOD_AMOUNT AMO,
ACB_GLOBAL_BUDGET GLO,
ACS_PERIOD PER,
ACS_FINANCIAL_CURRENCY CUR
WHERE ACC.ACS_FINANCIAL_ACCOUNT_ID =
GLO.ACS_FINANCIAL_ACCOUNT_ID
AND GLO.ACB_GLOBAL_BUDGET_ID = AMO.ACB_GLOBAL_BUDGET_ID
AND GLO.ACS_FINANCIAL_CURRENCY_ID =
CUR.ACS_FINANCIAL_CURRENCY_ID
AND CUR.FIN_LOCAL_CURRENCY = 1
AND AMO.ACS_PERIOD_ID = PER.ACS_PERIOD_ID) VBA,
(SELECT CLA.CLASSIFICATION_ID
FROM CLASSIFICATION CLA, CLASSIF_TABLES TAB
WHERE CLA.CLASSIFICATION_ID = TAB.CLASSIFICATION_ID
AND TAB.CTA_TABLENAME = 'ACS_ACCOUNT') VCL,
(SELECT ACS_FINANCIAL_ACCOUNT.ACS_FINANCIAL_ACCOUNT_ID,
ACS_ACCOUNT.ACC_NUMBER, ACS_DESCRIPTION.PC_LANG_ID,
ACS_DESCRIPTION.DES_DESCRIPTION_SUMMARY,
ACS_FUNCTION.ISFINACCOUNTINME(ACS_FINANCIAL_ACCOUNT.ACS_FINANCIAL_ACCOUNT_ID)ISFINACCOUNTINME
FROM ACS_DESCRIPTION,
ACS_ACCOUNT,
ACS_FINANCIAL_ACCOUNT,
ACS_SUB_SET
WHERE ACS_FINANCIAL_ACCOUNT.ACS_FINANCIAL_ACCOUNT_ID =
ACS_ACCOUNT.ACS_ACCOUNT_ID
AND ACS_ACCOUNT.ACS_ACCOUNT_ID =
ACS_DESCRIPTION.ACS_ACCOUNT_ID
AND ACS_ACCOUNT.ACS_SUB_SET_ID = ACS_SUB_SET.ACS_SUB_SET_ID
AND ACS_SUB_SET.C_SUB_SET = 'ACC') VAC
WHERE
    VAC.PC_LANG_ID = VPC_LANG_ID
AND VAC.ACS_FINANCIAL_ACCOUNT_ID = CFL.CLASSIF_LEAF_ID
AND CFL.CLASSIFICATION_ID = VCL.CLASSIFICATION_ID
AND CFL.PC_LANG_ID = VPC_LANG_ID
AND VAC.ACS_FINANCIAL_ACCOUNT_ID = VBA.ACS_FINANCIAL_ACCOUNT_ID
AND VBA.ID = TOT.ACT_TOTAL_BY_PERIOD_ID(+)
AND VBA.ACS_FINANCIAL_ACCOUNT_ID = TOT.ACS_FINANCIAL_ACCOUNT_ID(+)
AND TOT.ACS_PERIOD_ID = PER.ACS_PERIOD_ID(+)
AND VBA.ACS_DIVISION_ACCOUNT_ID = ACC.ACS_ACCOUNT_ID(+)
AND VBA.ID = PAM.ACB_PERIOD_AMOUNT_ID(+)
AND PAM.ACB_GLOBAL_BUDGET_ID = GLO.ACB_GLOBAL_BUDGET_ID(+)
AND GLO.ACB_BUDGET_VERSION_ID = VER.ACB_BUDGET_VERSION_ID(+)
AND PAM.ACS_PERIOD_ID = PER_BUD.ACS_PERIOD_ID(+)
AND VCL.CLASSIFICATION_ID = CLA.CLASSIFICATION_ID(+)
AND VCL.CLASSIFICATION_ID = TO_NUMBER(PARAMETER_0)
AND VBA.ACS_FINANCIAL_YEAR_ID IN (PARAMETER_1,PARAMETER_5,PARAMETER_9)
AND VBA.ACB_BUDGET_VERSION_ID IN (PARAMETER_4,PARAMETER_8,PARAMETER_12)
;
END ACR_BALANCE_3_COL_RPT_PK;




/**
*DESCRIPTION
USED FOR THE SUB REPORT OF  ACR_BALANCE_THREE_COL.RPT
*/
PROCEDURE ACR_BALANCE_3_COL_SUB_RPT_PK (
AREFCURSOR       IN OUT   CRYSTAL_CURSOR_TYPES.DUALCURSORTYP,
PROCUSER_LANID   IN       PCS.PC_LANG.LANID%TYPE,
PARAMETER_1      IN       NUMBER,
PARAMETER_4      IN       NUMBER,
PARAMETER_5      IN       NUMBER,
PARAMETER_8      IN       NUMBER,
PARAMETER_9      IN       NUMBER,
PARAMETER_12     IN       NUMBER,
PARAM_ACS_FINANCIAL_ACCOUNT_ID IN NUMBER
)

IS


VPC_LANG_ID   PCS.PC_LANG.PC_LANG_ID%TYPE;              --USER LANGUAGE ID


BEGIN
PCS.PC_I_LIB_SESSION.SETLANID (PROCUSER_LANID);
VPC_LANG_ID := PCS.PC_I_LIB_SESSION.GETUSERLANGID;



OPEN AREFCURSOR FOR
SELECT
VER.ACB_BUDGET_VERSION_ID,
PAM.PER_AMOUNT_D,
PAM.PER_AMOUNT_C,
ACC.ACS_ACCOUNT_ID,
ACS.FIN_LOCAL_CURRENCY,
CUR.CURRENCY,
PER.ACS_FINANCIAL_YEAR_ID,
PER.PER_NO_PERIOD,
PER_BUD.PER_NO_PERIOD BUD_PER_NO_PERIOD,
TOT.TOT_DEBIT_LC,
TOT.TOT_CREDIT_LC,
TOT.TOT_DEBIT_FC,
TOT.TOT_CREDIT_FC,
TOT.ACS_AUXILIARY_ACCOUNT_ID,
TOT.C_TYPE_CUMUL,
TOT.ACS_DIVISION_ACCOUNT_ID,
VAC.ACC_NUMBER
FROM ACB_BUDGET_VERSION VER,
ACB_GLOBAL_BUDGET GLO,
ACB_PERIOD_AMOUNT PAM,
ACS_ACCOUNT ACC,
ACS_FINANCIAL_CURRENCY ACS,
ACS_PERIOD PER,
ACS_PERIOD PER_BUD,
ACT_TOTAL_BY_PERIOD TOT,
PCS.PC_CURR CUR,
(SELECT ACC.ACS_FINANCIAL_ACCOUNT_ID,
TOT.ACS_DIVISION_ACCOUNT_ID,
TOT.ACT_TOTAL_BY_PERIOD_ID ID, 'TOT' TYP,
PER.ACS_FINANCIAL_YEAR_ID, 0 ACB_BUDGET_VERSION_ID
FROM ACS_FINANCIAL_ACCOUNT ACC,
ACT_TOTAL_BY_PERIOD TOT,
ACS_PERIOD PER
WHERE ACC.ACS_FINANCIAL_ACCOUNT_ID =
TOT.ACS_FINANCIAL_ACCOUNT_ID
AND TOT.ACS_PERIOD_ID = PER.ACS_PERIOD_ID
AND TOT.ACS_AUXILIARY_ACCOUNT_ID IS NULL
UNION ALL
SELECT ACC.ACS_FINANCIAL_ACCOUNT_ID,
GLO.ACS_DIVISION_ACCOUNT_ID, AMO.ACB_PERIOD_AMOUNT_ID ID,
'BUD' TYP, PER.ACS_FINANCIAL_YEAR_ID,
GLO.ACB_BUDGET_VERSION_ID
FROM ACS_FINANCIAL_ACCOUNT ACC,
ACB_PERIOD_AMOUNT AMO,
ACB_GLOBAL_BUDGET GLO,
ACS_PERIOD PER,
ACS_FINANCIAL_CURRENCY CUR
WHERE ACC.ACS_FINANCIAL_ACCOUNT_ID =
GLO.ACS_FINANCIAL_ACCOUNT_ID
AND GLO.ACB_GLOBAL_BUDGET_ID = AMO.ACB_GLOBAL_BUDGET_ID
AND GLO.ACS_FINANCIAL_CURRENCY_ID =
CUR.ACS_FINANCIAL_CURRENCY_ID
AND CUR.FIN_LOCAL_CURRENCY = 1
AND AMO.ACS_PERIOD_ID = PER.ACS_PERIOD_ID) VBA,
(SELECT ACS_FINANCIAL_ACCOUNT.ACS_FINANCIAL_ACCOUNT_ID,
ACS_ACCOUNT.ACC_NUMBER, ACS_DESCRIPTION.PC_LANG_ID,
ACS_DESCRIPTION.DES_DESCRIPTION_SUMMARY,
ACS_FUNCTION.ISFINACCOUNTINME(ACS_FINANCIAL_ACCOUNT.ACS_FINANCIAL_ACCOUNT_ID)ISFINACCOUNTINME
FROM ACS_DESCRIPTION,
ACS_ACCOUNT,
ACS_FINANCIAL_ACCOUNT,
ACS_SUB_SET
WHERE ACS_FINANCIAL_ACCOUNT.ACS_FINANCIAL_ACCOUNT_ID =
ACS_ACCOUNT.ACS_ACCOUNT_ID
AND ACS_ACCOUNT.ACS_ACCOUNT_ID =
ACS_DESCRIPTION.ACS_ACCOUNT_ID
AND ACS_ACCOUNT.ACS_SUB_SET_ID = ACS_SUB_SET.ACS_SUB_SET_ID
AND ACS_SUB_SET.C_SUB_SET = 'ACC') VAC
WHERE
    VAC.PC_LANG_ID = VPC_LANG_ID
AND VAC.ACS_FINANCIAL_ACCOUNT_ID = VBA.ACS_FINANCIAL_ACCOUNT_ID
AND VBA.ID = TOT.ACT_TOTAL_BY_PERIOD_ID(+)
AND TOT.ACS_PERIOD_ID = PER.ACS_PERIOD_ID(+)
AND TOT.ACS_ACS_FINANCIAL_CURRENCY_ID = ACS.ACS_FINANCIAL_CURRENCY_ID(+)
AND ACS.PC_CURR_ID = CUR.PC_CURR_ID(+)
AND VBA.ACS_DIVISION_ACCOUNT_ID = ACC.ACS_ACCOUNT_ID(+)
AND VBA.ID = PAM.ACB_PERIOD_AMOUNT_ID(+)
AND PAM.ACB_GLOBAL_BUDGET_ID = GLO.ACB_GLOBAL_BUDGET_ID(+)
AND GLO.ACB_BUDGET_VERSION_ID = VER.ACB_BUDGET_VERSION_ID(+)
AND PAM.ACS_PERIOD_ID = PER_BUD.ACS_PERIOD_ID(+)
AND VAC.ACS_FINANCIAL_ACCOUNT_ID = PARAM_ACS_FINANCIAL_ACCOUNT_ID
AND VBA.ACS_FINANCIAL_YEAR_ID IN (PARAMETER_1,PARAMETER_5,PARAMETER_9)
AND VBA.ACB_BUDGET_VERSION_ID IN (PARAMETER_4,PARAMETER_8,PARAMETER_12)
;

END ACR_BALANCE_3_COL_SUB_RPT_PK;

END ACR_RPT;
